# Notes de version Canopsis 22.10.0

Canopsis 22.10.0 a été publié le 28 octobre 2022.

## Procédure d'installation

Suivre la [procédure d'installation de Canopsis](../guide-administration/installation/index.md).

## Procédure de mise à jour

Canopsis 22.10.0 apporte des changements importants tant au niveau technique que fonctionnel. À ce titre, le [Guide de migration vers Canopsis 22.10.0](migration/migration-22.10.0.md) doit obligatoirement être suivi pour les mises à jour d'installations déjà en place.


## Changements entre Canopsis 4.6.x et 22.10.0

### Techniques / Infra

Mise à jour de timescaledb : https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4471

#### API d'export de configuration Canopsis

Une route d'API permettant d'exporter toutes les configurations présentes dans Canopsis a été ajoutée.  
Elle permet de générer un fichier `yaml` au format `fixture`. Le but étant de pouvoir importer les configurations en questions sur un environnement vierge.  
Voici un exemple d'utilisation

```sh
curl -X POST -u root:root -H "Content-type: application/json" -d '{
    "export": ["configuration", "acl","configuration", "pbehavior", "pbehavior_type","pbehavior_reason", 
"pbehavior_exception", "scenario", "metaalarm", "idle_rule", "eventfilter", "dynamic_infos", 
"playlist", "state_settings", "broadcast", "associative_table", "notification", "view", 
"view_tab", "widget", "widget_filter", "view_group", "instruction", "job_config", "job", 
"resolve_rule", "flapping_rule", "user_preferences", "kpi_filter", "pattern"]
}' 'http://localhost:8082/api/v4/export-configuration' > all_fixture_export.yml
```

Voici les différentes valeurs possibles :  

* `configuration` - export configuration collection
* `acl` - export default_rights collection
* `pbehavior` - export pbehavior collection
* `pbehavior_type` - export pbehavior_types collection
* `pbehavior_reason` - export pbehavior_reason collection
* `pbehavior_exception` - export pbehavior_exception collection
* `scenario` - export action_scenario collection
* `metaalarm` - export meta_alarm_rules collection
* `idle_rule` - export idle_rules collection
* `eventfilter` - export eventfilter collection
* `dynamic_infos` - export dynamic_infos collection
* `playlist` - export view_playlist collection
* `state_settings` - export state_settings collection
* `broadcast` - export broadcast_message collection
* `associative_table` - export default_associativetable collection
* `notification` - export notification collection
* `view` - export views collection
* `view_tab` - export viewtabs collection
* `widget` - export widgets collection
* `widget_filter` - export widget_filters collection
* `view_group` - export viewgroups collection
* `instruction` - export instruction collection
* `job_config` - export job_config collection
* `job` - export job collection
* `resolve_rule` - export resolve_rule collection
* `flapping_rule` - export flapping rule collection
* `user_preferences` - export userpreferences collection
* `kpi_filter` - export kpi_filter collection
* `pattern` - export pattern collection


Pour plus d'informations et notamment sur la manière d'importer les données exportées, reportez vous à la [documentation]()

### Moteur et API SNMP

Les API de traitements SNMP ont été migrées de Python à GO.  
Elles sont documentées dans Swagger.  

Le moteur SNMP reste quant à lui en Python mais ne dépend plus de la stack Canopsis d'origine.  

### Eventfiler / che

#### Calendrier d'exécution des règles d'eventfilter

Les règles d'eventfilter (drop, enrichissement) peuvent être exécutées selon un calendrier.  
Cas d'usage par exemple : supprimer des événements d'un périmètre donné pendant une journée spécifique.

![Calendrier Eventfilter](22.10.0-eventfilter-calendar.png)

### Suppression de la règle de recopie d'entité

Auparavant, pour enrichir une entité, il était nécessaire de définir une règle de recopie d'entité.  
L'action était la suivante : 

```json
{
	"from" : "ExternalData.entity",
	"type" : "copy",
	"to" : "Entity"
}
```

Cette règle est à présent gérée nativement par le moteur.


### Enrichissements par outils tiers

Il est désormais possible d'enrichir les événements par des outils externes de deux manières :

* via des collections MongoDB. 
Cela était déjà possible via un plugin. Le plugin a été supprimé au profit d'une implémentation native.

Par ailleurs, une fonction permet à présent d'utiliser des expressions régulières pour sélectionner les données dans les collections mongodb.

* via des API qui répondent au format JSON

Le formulaire de définition des appels API est identique à celui des webhooks.


Vous trouverez dans le formulaire d'enrichissement les éléments suivants : 

![Eventfilter enrichissements](./img/22.10.0-eventfilter-enrich.png)


### WebUI

Plein ecran direct : https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4395
https://localhost:4438/kiosk-views/6d912394-b237-41fe-a174-487374faccd4/9199926a-5be6-4a52-9f41-9d813e269271

### Remédiation

Currently in progress
https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4422

Jeu d'icônes : https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4336

Ajout d'un type de remadiation : simplifié : https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4474
### Fonctionnalité TAG

https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4524
https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4532


### Ergonomie des patterns

https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4149
https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4194

### Widget Cartographie

https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4468

### Vues partagées

https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4394

### Connecteur Zabbix Webhook

Gestion des tags

### Liste des modifications

*  **UI :**
    * Ajout d'un widget `Cartographie` (#4468)
    * Les droits des vues sont maintenant classés par groupes de vue (#4420)
    * Il existe désormais une URL permettant d'accéder à une vue en plein écran direct (#4395)
    * Ajout d'options de Timeout de déconnexion pour les groupes et les mécanismes d'authentification (#3996)
    * Ajout d'un compteur de connexions sur le panneau de gestion des utilisateurs (#4403)
    * Ajout de la possibilité de se logguer sur l'interface web grâce à une authkey (#4394)
    * **Bac à alarmes**
	* Les dates d'acquittement sont désormais affichées en format date et non timestamp (#4456)
	* Les actions du bac sont accessibles en fullscreen (#4507)
	* La liste des variables d'une alarme est maintenant exportable (#4410)
	* Ajout de la possibilité de désactiver la suppression du filtre par défaut (#4380,#4404)
	* Les filtres de remédiation peuvent afficher les alarmes avec une remédiation en cours (#4422)
	* Ajout d'une fonctionnalité d'affichage de tags (#4524, #4532)
	* Ajout d'un système de sélection multiple avec la touche `Ctrl` (#4378)
	* Un jeu complet d'icônes est mis en place pour présenter les statuts des remédiations (#4336)
    * **Météo des services**
	* Ajout de la variable `.Depends` accessible dans l'Output_Template des services (#4337)
    * **Remediation**
        * Les timeout et intervalle sont maintenant paramétrables au job près (#4424)
	* Ajout d'une zone de recherche dans la chronologie des alarmes des statistiques de remédiation (#4281)
	* Ajout d'un indicateur de remédiation : le pourcentage d'alarmes pouvant être remédiées (#4277)
	* Les consignes, configurations, et jobs epuvent être dupliqués (#4545)
	* Ajout d'un type de consigne : `Manuel simplifié` (#4474)
*  **API :**
    * La consultation des Comportements périodiques ne nécessite plus de droit CREATE (#4530)
    * La route `app-info` renvoie désormais la date d'installation de Canopsis (#4379)
    * Healthcheck : correction d'un bug qui donnait `redis`et `mongodb` non fonctionnels à tort (#4555, #4489)
    * Ajout d'une route `export-configuration` permettant d'exporter toutes les configurations de Canopsis au format "fixture" (#3988)
*  **Moteurs :**
        * A prséent, lorsque qu'une règle de corrélation est supprimée, les méta alarmes associées sont également supprimées (#4371)
    * **Correlation**
        * A prséent, lorsque qu'une règle de corrélation est supprimée, les méta alarmes associées sont également supprimées (#4371)
    * **Axe**
        * Suppression des options de lancement suivantes : `-featureHideResources`, `-postProcessorsDirectory`, `-ignoreDefaultTomlConfig` (#4536)
    * **Che**
        * Suppression des options de lancement suivantes : `-dataSourceDirectory`, `enrichContext`, `enrichExclude`, `enrichInclude` (#4536)
	* Les règles `eventfilter` peuvent bénéficier d'un calendrier d'exécution (#4324)
	* Il est désormais possible d'enrichir un événement à partir d'une API JSON tierce (#79)
	* Il n'est plus nécessaire de paramétrer la règle d'enrichissement d'entité par défaut (#80)
	* Suppression du plugin datasource Mongodb au profit d'un mécanisme natif (#80)
	* Possibilité d'utiliser des expressions régulières dans l'enrichissement via mongodb (#4494)
    * **Pbehavior**
        * Suppression des options de lancement suivantes : `-publishQueue`, `-consumeQueue`, `-fifoAckExchange` (#4536)
    * **FIFO**
        * Suppression des options de lancement suivantes : `-dataSourceDirectory`, `enableMetaAlarmProcessing` (#4536)
*  **Connecteurs :**
    * **snmp2canopsis** : Le log de sortie du connecteur est désormais mono ligne (#4512)
    * **zabbix** : Le connecteur supporte à présent la transmission des tags et de leur valeur (#
*  **Général :**
    * **Canopsis-reconfigure** : Correction d'un bug qui empêchait la surcharge de certains attributs (#4537)
    * **Patterns** : Ajout d'un système d'auto completion des filtres (#4149,4194)
    * **Timescaledb** : Mise à jour de Timescaleddb (#4471)
*  **Documentation :**
    * [Section Remediation de canopsis.toml](https://doc.canopsis.net/guide-administration/administration-avancee/modification-canopsis-toml/#section-remediation)
