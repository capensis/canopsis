# Notes de version Canopsis 23.04.0

Canopsis 23.04.0 a été publié le xx avril 2023.

## Procédure d'installation

Suivre la [procédure d'installation de Canopsis](../guide-administration/installation/index.md).

## Procédure de mise à jour

Canopsis 23.04.0 apporte des changements importants tant au niveau technique que fonctionnel. À ce titre, le [Guide de migration vers Canopsis 23.04.0](migration/migration-23.04.0.md) doit obligatoirement être suivi pour les mises à jour d'installations déjà en place.

## Changements entre Canopsis 22.10.0 23.04.0

### Modifications majeures sur le widget Weather

* https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4548

### Fonctionnalité Thèmes

* https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4589

### Fonctionnalité des templates de colonnes, moreInfos etc

* https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4688

### Fonctionnalité déclaration de tickets

Un module de déclaration de tickets à été introduit dans Canopsis.  
Jusque là, lorsqu'un pilote souhaitait interagir avec un outil de ticketing, il utilisait le module [Scénario](../../../guide-utilisation/menu-exploitation/scenarios/) couplé avec le déclencheur `declareticket`.  
A présent, Canopsis est doté d'un module dédié à cela. 

Ce module permet de 

* Définir des règles de déclaration de ticket sur plusieurs outils de ticketing
* Traiter les retours des API de ces outils
* Déclarer un ticket par alarme sélectionnée
* Déclarer un seul et même ticket à partir de plusieurs alarmes
* De visualiser pour une alarme l'historique des tickets déclarés

Pour plus d'informations, veuillez vous référer à la [documentation](../../../guide-utilisation/menu-exploitation/regles-declaration-tickets/).


### Attributs `impact`et `depends` des entités

Les attributs `impact` et `depends` des entités ont été supprimés afin d'améliorer les performances (calcul de dépendances + comportements périodiques + espace occupés par des requêtes à la base de données).  
L'impact coté utilisateur se limite 

* aux filtres d'ancienne générations qui utiliseraient ces attributs (il n'était déjà plus possible de les utiliser dans les nouveaux patterns)
* aux scripts externes que vous utilisez peut-être.

Pour information, voici le comparatif entre les anciennes structures et les nouvelles structures

??? note "Comparatif"

    === "Ressource"

        Avant : 
        ```json
        {
          "_id": "cps_resource/cps_component",
          "depends": ["cps_connector/cps_connector_name"],
          "impact": ["cps_component", "cps_service_1", "cps_service_2"]
        }
        ```
        
        Après : 
        ```json
        {
          "_id": "cps_resource/cps_component",
          "connector": "cps_connector/cps_connector_name",
          "component": "cps_component",
          "services": ["cps_service_1", "cps_service_2"]
        }
        ```

    === "Composant"

        Avant : 
        ```json
        {
          "_id": "cps_component",
          "depends": ["cps_resource_1/cps_component", ..., "cps_resource_100000/cps_component"],
          "impact": ["cps_connector/cps_connector_name"]
        }
        ```
        
        Après : 
        ```json
        {
          "_id": "cps_component",
          "connector": "cps_connector/cps_connector_name"
        }
        ```

    === "Connecteur"

        Avant : 
        ```json
        {
          "_id": "cps_connector/cps_connector_name",
          "depends": ["cps_component"],
          "impact": ["cps_resource_1/cps_component", ... ,"cps_resource_100000/cps_component"]
        }
        ```
        
        Après : 
        ```json
        {
          "_id": "cps_connector/cps_connector_name"
        }
        ```

    === "Service"

        Avant : 
        ```json
        {
          "_id": "cps_service_1",
          "depends": ["cps_resource_1/cps_component", ... ,"cps_resource_100000/cps_component"]
          "impact": []
        }
        ```
        
        Après : 
        ```json
        {
          "_id": "cps_service_1"
        }
        ```

### Les types et raisons de comportements périodiques peuvent être cachés

Lorsque vous utilisez des types ou des raisons personnalisés de comportements périodiques, vous pouvez "cacher" les types et raisons par défaut.  
Cela permet aux utilisateurs de ne voir que les types et raisons qui vous intéressent.

![Cacher les types](./img/23.04.0-hidepbh.png)


### Remédiation

Décalage de l'activation d'une alarme à la fin d'une auto remédiation
https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4826

Ajout de triggers autre que create pour l'exécution de remédiation automatique 
https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4483


### Homogénéisation des priorités de règles
https://git.canopsis.net/canopsis/canopsis-pro/-/issues/4426

### Améliorations des imports

Afin d'enrichir les entités gérées par Canopsis, vous pouvez utiliser des [règles d'enrichissement](../../../guide-utilisation/menu-exploitation/filtres-evenements/) importer des informations de référentiel par anticipation.  
C'est la commande [import-context-graph](../../../interconnexions/drivers/driver-api/) qui vous permet cela.  
A présent, le mécanisme d'import pour permet d'importer : 

* Des ressources
* Des entités
* Des services

Par ailleurs, [différentes actions](../../../interconnexions/drivers/driver-api/#les-differentes-actions) ont été mises à disposition pour faciliter la transformations de données.  

Enfin, [un exemple complet](../../../interconnexions/drivers/cas-d-usage-complet/) est documenté.


### Liste des modifications

*  **UI :**
    * Le helper handlebars `request` support désormais la méthode POST (#4732)
    * Les paramètres des colonnes de bac à alarmes des widgets Météo et Compteurs sont maintenant alignés vers le bac à alarmes (#4783)
    * Correction d'un bug de droit qui empêchait l'utilisation de partage de token (#4875)
    * **Bac à alarmes**
        * Ajout de l'action de masse `Commentaire` (#4793)
        * Ajout de l'action `Fast cancel` ou `Annulation rapide` (#4792)
        * En utilisant le mode `sticky header`, les entêtes de colonnes ainsi que les actions de masse restent affichées (#4828)
        * Correction d'un bug de droits qui permettait à un utilisateur non autorisé de modifier des filtres (#4865)
        * Les paramètres des `colonnes pour le suivi de cause racine` sont à nouveau fonctionnels (#4848)
    * **Explorateur de contexte**
        * Ajout du support des colonnes `import_source` et `imported` (#4806)
        * Ajout du support de la colonne `Date du dernier comportement périodique` (#349)
    * **Comportements périodiques**
        * Ajout d'un sélecteur rapide de dates, notamment pour sélectionner les années (#4539)
        * Les couleurs des comportements périodiques peuvent à présent être définies au type et au pbh près (#4543)
    * **Remediation**
        * Les sorties de jobs sont affichées correctement (#4594)
        * Le timeout après exécution d'une remédiation est présenté dans le tableau de chronologie des alarmes (#4746)
        * Correction d'un bug qui entrainait un non rafraichissement des icônes de remédiation lorsque la timeline était ouverte (#4821)
    * **Scenatio/Webhook**
        * Ajout de la variable `{{ .AdditionalData.RuleName }}`, accessible dans un payload (#4513)
*  **API :**
    * La consultation des Comportements périodiques ne nécessite plus de droit CREATE (#4530)
*  **Moteurs :**
    * **Remédiation**
        * Prise en compte du statut `FAILURE` pour l'odonnanceur `Jenkins` (#4683)
    * **Axe:**
        * Les événements de type `done` ne sont plus traités par Canopsis (#4631)
*  **Connecteurs :**
    * **zabbix** : Le connecteur supporte à présent la transmission des tags et de leur valeur (#
*  **Templates GO :**
    * Ajout des fonctions `tag_has_key` et `get_tag` (#4716)
    * Ajout de la possibilité d'utiliser des variables d'environnement dans des templates GO (#4514)
*  **Général :**
    * **Timescaledb** : Mise à jour de Timescaledb 
*  **Documentation :**
    * [Templates GO](https://doc.canopsis.net/guide-utilisation/templates-go/)
