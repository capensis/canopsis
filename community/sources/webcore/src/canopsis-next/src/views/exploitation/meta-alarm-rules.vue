<template>
  <div>
    <c-page-header />
    <v-card class="ma-4 mt-0">
      <meta-alarm-rule-list
        :rules="metaAlarmRules"
        :pending="metaAlarmRulesPending"
        :total-items="metaAlarmRulesMeta.total_count"
        :options.sync="options"
        :removable="hasDeleteAnyMetaAlarmRuleAccess"
        :updatable="hasUpdateAnyMetaAlarmRuleAccess"
        :duplicable="hasCreateAnyMetaAlarmRuleAccess"
        @edit="showEditRuleModal"
        @duplicate="showDuplicateRuleModal"
        @remove="showDeleteRuleModal"
        @remove-selected="showDeleteSelectedRulesModal"
      />
    </v-card>
    <c-fab-btn
      :has-access="hasCreateAnyMetaAlarmRuleAccess"
      @refresh="fetchList"
      @create="showCreateRuleModal"
    >
      <span>{{ $t('modals.metaAlarmRule.create.title') }}</span>
    </c-fab-btn>
  </div>
</template>

<script>
import { omit } from 'lodash';

import { MODALS } from '@/constants';

import { entitiesMetaAlarmRuleMixin } from '@/mixins/entities/meta-alarm-rule';
import {
  permissionsTechnicalExploitationMetaAlarmRuleMixin,
} from '@/mixins/permissions/technical/exploitation/meta-alarm-rule';
import { localQueryMixin } from '@/mixins/query/query';

import MetaAlarmRuleList from '@/components/other/meta-alarm-rule/meta-alarm-rule-list.vue';

export default {
  components: {
    MetaAlarmRuleList,
  },
  mixins: [
    localQueryMixin,
    entitiesMetaAlarmRuleMixin,
    permissionsTechnicalExploitationMetaAlarmRuleMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    showCreateRuleModal() {
      this.$modals.show({
        name: MODALS.createMetaAlarmRule,
        config: {
          action: data => this.createMetaAlarmRuleWithPopup({ data }),
        },
      });
    },

    showDuplicateRuleModal(rule) {
      this.$modals.show({
        name: MODALS.createMetaAlarmRule,
        config: {
          title: this.$t('modals.metaAlarmRule.duplicate.title'),
          rule: omit(rule, ['_id']),
          isDuplicating: true,
          action: data => this.duplicateMetaAlarmRuleWithPopup({ data }),
        },
      });
    },

    showEditRuleModal(rule) {
      this.$modals.show({
        name: MODALS.createMetaAlarmRule,
        config: {
          rule,
          title: this.$t('modals.metaAlarmRule.edit.title'),
          isDisabledIdField: true,
          action: data => this.updateMetaAlarmRuleWithPopup({ id: rule._id, data }),
        },
      });
    },

    showDeleteRuleModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          text: this.$t('metaAlarmRule.removeConfirmationText'),
          action: () => this.removeMetaAlarmRuleWithPopup({ id }),
        },
      });
    },

    showDeleteSelectedRulesModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          text: this.$t('metaAlarmRule.removeConfirmationText'),
          action: () => this.removeSelectedMetaAlarmRuleWithPopup(selected),
        },
      });
    },

    async createMetaAlarmRuleWithPopup({ data }) {
      await this.createMetaAlarmRule({ data });
      this.$popups.success({ text: this.$t('modals.metaAlarmRule.create.success') });

      this.fetchList();
    },

    async duplicateMetaAlarmRuleWithPopup({ data }) {
      await this.createMetaAlarmRule({ data });
      this.$popups.success({ text: this.$t('modals.metaAlarmRule.duplicate.success') });

      this.fetchList();
    },

    async updateMetaAlarmRuleWithPopup({ id, data }) {
      await this.updateMetaAlarmRule({ id, data });
      this.$popups.success({ text: this.$t('modals.metaAlarmRule.edit.success') });

      this.fetchList();
    },

    async removeMetaAlarmRuleWithPopup({ id }) {
      await this.removeMetaAlarmRule({ id });
      this.$popups.success({ text: this.$t('modals.metaAlarmRule.remove.success') });

      this.fetchList();
    },

    async removeSelectedMetaAlarmRuleWithPopup(selected) {
      await Promise.all(selected.map(({ _id: id }) => this.removeMetaAlarmRule({ id })));
      this.$popups.success({ text: this.$t('modals.metaAlarmRule.remove.success') });

      this.fetchList();
    },

    fetchList() {
      this.fetchMetaAlarmRulesList({ params: this.getQuery() });
    },
  },
};
</script>
