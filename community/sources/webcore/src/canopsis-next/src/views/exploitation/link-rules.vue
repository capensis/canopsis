<template lang="pug">
  div
    c-page-header
    v-card.ma-4.mt-0
      link-rules-list(
        :pagination.sync="pagination",
        :link-rules="linkRules",
        :total-items="linkRulesMeta.total_count",
        :pending="linkRulesPending",
        :updatable="hasUpdateAnyLinkRuleAccess",
        :removable="hasDeleteAnyLinkRuleAccess",
        :duplicable="hasCreateAnyLinkRuleAccess",
        @edit="showEditLinkRuleModal",
        @duplicate="showDuplicateLinkRuleModal",
        @remove="showDeleteLinkRuleModal",
        @remove-selected="showDeleteSelectedLinkRuleModal"
      )
    c-fab-btn(
      :has-access="hasCreateAnyLinkRuleAccess",
      @refresh="fetchList",
      @create="showCreateLinkRuleModal"
    )
      span {{ $t('modals.createLinkRule.create.title') }}
</template>

<script>
import { omit } from 'lodash';

import { MODALS } from '@/constants';

import { pickIds } from '@/helpers/array';

import { localQueryMixin } from '@/mixins/query-local/query';
import { entitiesLinkRuleMixin } from '@/mixins/entities/link-rule';
import { permissionsTechnicalExploitationLinkRuleMixin } from '@/mixins/permissions/technical/exploitation/link-rule';

import LinkRulesList from '@/components/other/link-rule/link-rules-list.vue';

export default {
  components: {
    LinkRulesList,
  },
  mixins: [
    localQueryMixin,
    entitiesLinkRuleMixin,
    permissionsTechnicalExploitationLinkRuleMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    fetchList() {
      this.fetchLinkRulesList({ params: this.getQuery() });
    },

    showCreateLinkRuleModal() {
      this.$modals.show({
        name: MODALS.createLinkRule,
        config: {
          title: this.$t('modals.createLinkRule.create.title'),
          action: async (data) => {
            await this.createLinkRule({ data });

            this.fetchList();
          },
        },
      });
    },

    showDuplicateLinkRuleModal(linkRule) {
      this.$modals.show({
        name: MODALS.createLinkRule,
        config: {
          title: this.$t('modals.createLinkRule.duplicate.title'),
          linkRule: omit(linkRule, ['_id']),
          action: async (data) => {
            await this.createLinkRule({ data });

            this.fetchList();
          },
        },
      });
    },

    showEditLinkRuleModal(linkRule) {
      this.$modals.show({
        name: MODALS.createLinkRule,
        config: {
          linkRule,
          title: this.$t('modals.createLinkRule.edit.title'),
          action: async (data) => {
            await this.updateLinkRule({ id: linkRule._id, data });

            this.fetchList();
          },
        },
      });
    },

    showDeleteLinkRuleModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.removeLinkRule({ id });

            this.fetchList();
          },
        },
      });
    },

    showDeleteSelectedLinkRuleModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.bulkRemoveLinkRules({
              data: pickIds(selected),
            });

            return this.fetchList();
          },
        },
      });
    },
  },
};
</script>
