<template>
  <div>
    <c-page-header />
    <v-card class="ma-4 mt-0">
      <scenarios-list
        :options.sync="options"
        :scenarios="scenarios"
        :total-items="scenariosMeta.total_count"
        :pending="scenariosPending"
        :duplicable="hasCreateAnyScenarioAccess"
        :removable="hasDeleteAnyScenarioAccess"
        :updatable="hasUpdateAnyScenarioAccess"
        @edit="showEditScenarioModal"
        @duplicate="showDuplicateScenarioModal"
        @remove="showDeleteScenarioModal"
        @remove-selected="showDeleteSelectedScenariosModal"
      />
    </v-card>
    <c-fab-btn
      v-if="hasCreateAnyScenarioAccess"
      @refresh="fetchList"
      @create="showCreateScenarioModal"
    >
      <span>{{ $t('modals.createScenario.create.title') }}</span>
    </c-fab-btn>
  </div>
</template>

<script>
import { omit } from 'lodash';

import { MODALS } from '@/constants';

import { localQueryMixin } from '@/mixins/query/query';
import { entitiesScenarioMixin } from '@/mixins/entities/scenario';
import { permissionsTechnicalExploitationScenarioMixin } from '@/mixins/permissions/technical/exploitation/scenario';

import ScenariosList from '@/components/other/scenario/scenarios-list.vue';

export default {
  components: {
    ScenariosList,
  },
  mixins: [
    localQueryMixin,
    entitiesScenarioMixin,
    permissionsTechnicalExploitationScenarioMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    fetchList() {
      this.fetchScenariosList({ params: this.getQuery() });
    },

    showCreateScenarioModal() {
      this.$modals.show({
        name: MODALS.createScenario,
        config: {
          action: data => this.createScenarioWithPopup({ data }),
        },
      });
    },

    showEditScenarioModal(scenario) {
      this.$modals.show({
        name: MODALS.createScenario,
        config: {
          scenario,
          title: this.$t('modals.createScenario.edit.title'),
          action: data => this.updateScenarioWithPopup({ id: scenario._id, data }),
        },
      });
    },

    showDuplicateScenarioModal(scenario) {
      this.$modals.show({
        name: MODALS.createScenario,
        config: {
          scenario: omit(scenario, ['_id']),
          title: this.$t('modals.createScenario.duplicate.title'),
          action: data => this.createScenarioWithPopup({ data }),
        },
      });
    },

    showDeleteScenarioModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeScenarioWithPopup({ id }),
        },
      });
    },

    showDeleteSelectedScenariosModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeSelectedScenariosWithPopup(selected),
        },
      });
    },

    async createScenarioWithPopup({ data }) {
      await this.createScenario({ data });
      this.$popups.success({ text: this.$t('modals.createScenario.create.success') });
      this.fetchList();
    },

    async updateScenarioWithPopup({ id, data }) {
      await this.updateScenario({ id, data });
      this.$popups.success({ text: this.$t('modals.createScenario.edit.success') });
      this.fetchList();
    },

    async removeScenarioWithPopup({ id }) {
      await this.removeScenario({ id });
      this.$popups.success({ text: this.$t('modals.createScenario.remove.success') });
      this.fetchList();
    },

    async removeSelectedScenariosWithPopup(selected) {
      await Promise.all(selected.map(({ _id: id }) => this.removeScenario({ id })));
      this.$popups.success({ text: this.$t('modals.createScenario.remove.success') });
      this.fetchList();
    },
  },
};
</script>
