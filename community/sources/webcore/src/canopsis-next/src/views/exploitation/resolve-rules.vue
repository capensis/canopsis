<template lang="pug">
  div
    c-page-header
    v-card.ma-4.mt-0
      alarm-status-rules-list(
        :pagination.sync="pagination",
        :rules="resolveRules",
        :total-items="resolveRulesMeta.total_count",
        :pending="resolveRulesPending",
        :updatable="hasUpdateAnyResolveRuleAccess",
        :removable="hasDeleteAnyResolveRuleAccess",
        :duplicable="hasCreateAnyResolveRuleAccess",
        @edit="showEditResolveRuleModal",
        @duplicate="showDuplicateResolveRuleModal",
        @remove="showDeleteResolveRuleModal",
        @remove-selected="showDeleteSelectedResolveRulesModal"
      )
    c-fab-btn(
      :has-access="hasCreateAnyResolveRuleAccess",
      dark,
      @refresh="fetchList",
      @create="showCreateResolveRuleModal"
    )
      span {{ $t('modals.createAlarmStatusRule.resolve.create.title') }}
</template>

<script>
import { MODALS } from '@/constants';

import { localQueryMixin } from '@/mixins/query-local/query';
import { entitiesResolveRulesMixin } from '@/mixins/entities/resolve-rules';
import {
  permissionsTechnicalExploitationResolveRulesMixin,
} from '@/mixins/permissions/technical/exploitation/resolve-rules';

import AlarmStatusRulesList from '@/components/other/alarm-status-rule/alarm-status-rules-list.vue';

export default {
  components: {
    AlarmStatusRulesList,
  },
  mixins: [
    localQueryMixin,
    entitiesResolveRulesMixin,
    permissionsTechnicalExploitationResolveRulesMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    fetchList() {
      this.fetchResolveRulesList({ params: this.getQuery() });
    },

    showCreateResolveRuleModal() {
      this.$modals.show({
        name: MODALS.createAlarmStatusRule,
        config: {
          title: this.$t('modals.createAlarmStatusRule.resolve.create.title'),
          action: async (data) => {
            await this.createResolveRule({ data });

            return this.fetchList();
          },
        },
      });
    },

    showEditResolveRuleModal(rule) {
      this.$modals.show({
        name: MODALS.createAlarmStatusRule,
        config: {
          rule,

          title: this.$t('modals.createAlarmStatusRule.resolve.edit.title'),
          action: async (data) => {
            await this.updateResolveRule({ id: rule._id, data });

            return this.fetchList();
          },
        },
      });
    },

    showDuplicateResolveRuleModal(rule) {
      this.$modals.show({
        name: MODALS.createAlarmStatusRule,
        config: {
          rule,

          title: this.$t('modals.createAlarmStatusRule.resolve.duplicate.title'),
          action: async (data) => {
            await this.createResolveRule({ data });

            return this.fetchList();
          },
        },
      });
    },

    showDeleteResolveRuleModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.removeResolveRule({ id });

            return this.fetchList();
          },
        },
      });
    },

    showDeleteSelectedResolveRulesModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await Promise.all(selected.map(({ _id: id }) => this.removeResolveRule({ id })));

            return this.fetchList();
          },
        },
      });
    },
  },
};
</script>
