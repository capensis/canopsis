<template lang="pug">
  div
    c-page-header
    event-filter-rules-list(
      :rules="eventFilterRules",
      :pending="eventFilterRulesPending",
      :total-items="eventFilterRulesMeta.total_count",
      :pagination.sync="pagination",
      @edit="showEditRuleModal",
      @duplicate="showDuplicateRuleModal",
      @remove="showDeleteRuleModal",
      @remove-selected="showDeleteSelectedRulesModal"
    )
    c-fab-btn(
      :has-access="hasCreateAnyEventFilterAccess",
      dark,
      @refresh="fetchList",
      @create="showCreateRuleModal"
    )
      span {{ $t('modals.eventFilterRule.create.title') }}
</template>

<script>
import { omit } from 'lodash';

import { MODALS } from '@/constants';

import { entitiesEventFilterRuleMixin } from '@/mixins/entities/event-filter-rule';
import {
  permissionsTechnicalExploitationEventFilterMixin,
} from '@/mixins/permissions/technical/exploitation/event-filter';
import { localQueryMixin } from '@/mixins/query-local/query';

import EventFilterRulesList from '@/components/other/event-filter/exploitation/event-filter-rules-list.vue';

export default {
  components: {
    EventFilterRulesList,
  },
  mixins: [
    localQueryMixin,
    entitiesEventFilterRuleMixin,
    permissionsTechnicalExploitationEventFilterMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    showCreateRuleModal() {
      this.$modals.show({
        name: MODALS.createEventFilterRule,
        config: {
          action: data => this.createEventFilterRuleWithPopup({ data }),
        },
      });
    },

    showDuplicateRuleModal(rule) {
      this.$modals.show({
        name: MODALS.createEventFilterRule,
        config: {
          title: this.$t('modals.eventFilterRule.duplicate.title'),
          rule: omit(rule, ['_id']),
          action: data => this.duplicateEventFilterRuleWithPopup({ data }),
        },
      });
    },

    showEditRuleModal(rule) {
      this.$modals.show({
        name: MODALS.createEventFilterRule,
        config: {
          rule,
          title: this.$t('modals.eventFilterRule.edit.title'),
          isDisabledIdField: true,
          action: data => this.updateEventFilterRuleWithPopup({ id: rule._id, data }),
        },
      });
    },

    showDeleteRuleModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeEventFilterRuleWithPopup({ id }),
        },
      });
    },

    showDeleteSelectedRulesModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeSelectedEventFilterRuleWithPopup(selected),
        },
      });
    },

    async createEventFilterRuleWithPopup({ data }) {
      await this.createEventFilterRule({ data });
      this.$popups.success({ text: this.$t('modals.eventFilterRule.create.success') });
      this.fetchList();
    },

    async duplicateEventFilterRuleWithPopup({ data }) {
      await this.createEventFilterRule({ data });
      this.$popups.success({ text: this.$t('modals.eventFilterRule.duplicate.success') });
      this.fetchList();
    },

    async updateEventFilterRuleWithPopup({ id, data }) {
      await this.updateEventFilterRule({ id, data });
      this.$popups.success({ text: this.$t('modals.eventFilterRule.edit.success') });
      this.fetchList();
    },

    async removeEventFilterRuleWithPopup({ id }) {
      await this.removeEventFilterRule({ id });
      this.$popups.success({ text: this.$t('modals.eventFilterRule.remove.success') });
      this.fetchList();
    },

    async removeSelectedEventFilterRuleWithPopup(selected) {
      await Promise.all(selected.map(({ _id: id }) => this.removeEventFilterRule({ id })));
      this.$popups.success({ text: this.$t('modals.eventFilterRule.remove.success') });
      this.fetchList();
    },

    fetchList() {
      this.fetchEventFilterRulesList({ params: this.getQuery() });
    },
  },
};
</script>
