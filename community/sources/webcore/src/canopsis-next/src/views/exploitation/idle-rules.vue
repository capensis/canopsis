<template>
  <div>
    <c-page-header />
    <v-card class="ma-4 mt-0">
      <idle-rules-list
        :options.sync="options"
        :idle-rules="idleRules"
        :total-items="idleRulesMeta.total_count"
        :pending="idleRulesPending"
        :updatable="hasUpdateAnyIdleRuleAccess"
        :removable="hasDeleteAnyIdleRuleAccess"
        :duplicable="hasCreateAnyIdleRuleAccess"
        @edit="showEditIdleRuleModal"
        @duplicate="showDuplicateIdleRuleModal"
        @remove="showDeleteIdleRuleModal"
        @remove-selected="showDeleteSelectedIdleRulesModal"
      />
    </v-card>
    <c-fab-expand-btn
      @refresh="fetchList"
      :has-access="hasCreateAnyIdleRuleAccess"
    >
      <c-action-fab-btn
        :tooltip="$t('modals.createEntityIdleRule.create.title')"
        color="deep-purple"
        icon="perm_identity"
        top
        @click="showCreateEntityIdleRuleModal"
      />
      <c-action-fab-btn
        :tooltip="$t('modals.createAlarmIdleRule.create.title')"
        color="indigo"
        icon="add_alert"
        top
        @click="showCreateAlarmIdleRuleModal"
      />
    </c-fab-expand-btn>
  </div>
</template>

<script>
import { IDLE_RULE_TYPES, MODALS } from '@/constants';

import { localQueryMixin } from '@/mixins/query-local/query';
import { entitiesIdleRulesMixin } from '@/mixins/entities/idle-rules';
import { permissionsTechnicalExploitationIdleRulesMixin } from '@/mixins/permissions/technical/exploitation/idle-rules';

import IdleRulesList from '@/components/other/idle-rule/idle-rules-list.vue';

export default {
  components: {
    IdleRulesList,
  },
  mixins: [
    localQueryMixin,
    entitiesIdleRulesMixin,
    permissionsTechnicalExploitationIdleRulesMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    fetchList() {
      this.fetchIdleRulesList({ params: this.getQuery() });
    },

    showCreateEntityIdleRuleModal() {
      this.$modals.show({
        name: MODALS.createIdleRule,
        config: {
          idleRule: { type: IDLE_RULE_TYPES.entity },
          title: this.$t('modals.createEntityIdleRule.create.title'),
          action: async (data) => {
            await this.createIdleRule({ data });

            this.fetchList();
          },
        },
      });
    },

    showCreateAlarmIdleRuleModal() {
      this.$modals.show({
        name: MODALS.createIdleRule,
        config: {
          action: async (data) => {
            await this.createIdleRule({ data });

            this.fetchList();
          },
        },
      });
    },

    showEditIdleRuleModal(idleRule) {
      this.$modals.show({
        name: MODALS.createIdleRule,
        config: {
          idleRule,
          title: idleRule.type === IDLE_RULE_TYPES.entity
            ? this.$t('modals.createEntityIdleRule.edit.title')
            : this.$t('modals.createAlarmIdleRule.edit.title'),
          action: async (data) => {
            await this.updateIdleRule({ id: idleRule._id, data });

            this.fetchList();
          },
        },
      });
    },

    showDuplicateIdleRuleModal(idleRule) {
      this.$modals.show({
        name: MODALS.createIdleRule,
        config: {
          idleRule,
          title: idleRule.type === IDLE_RULE_TYPES.entity
            ? this.$t('modals.createEntityIdleRule.duplicate.title')
            : this.$t('modals.createAlarmIdleRule.duplicate.title'),
          action: async (data) => {
            await this.createIdleRule({ data });

            this.fetchList();
          },
        },
      });
    },

    showDeleteIdleRuleModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.removeIdleRule({ id });

            this.fetchList();
          },
        },
      });
    },

    showDeleteSelectedIdleRulesModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await Promise.all(selected.map(({ _id: id }) => this.removeIdleRule({ id })));

            this.fetchList();
          },
        },
      });
    },
  },
};
</script>
