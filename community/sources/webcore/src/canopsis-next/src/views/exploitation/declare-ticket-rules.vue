<template lang="pug">
  div
    c-page-header
    v-card.ma-4.mt-0
      declare-ticket-rules-list(
        :pagination.sync="pagination",
        :declare-ticket-rules="declareTicketRules",
        :total-items="declareTicketRulesMeta.total_count",
        :pending="declareTicketRulesPending",
        :updatable="hasUpdateAnyDeclareTicketRuleAccess",
        :removable="hasDeleteAnyDeclareTicketRuleAccess",
        :duplicable="hasCreateAnyDeclareTicketRuleAccess",
        @edit="showEditDeclareTicketRuleModal",
        @duplicate="showDuplicateDeclareTicketRuleModal",
        @remove="showDeleteDeclareTicketRuleModal",
        @remove-selected="showDeleteSelectedDeclareTicketRulesModal"
      )
    c-fab-btn(
      :has-access="hasCreateAnyDeclareTicketRuleAccess",
      @refresh="fetchList",
      @create="showCreateDeclareTicketRuleModal"
    )
</template>

<script>
import { MODALS } from '@/constants';

import { localQueryMixin } from '@/mixins/query-local/query';
import { entitiesDeclareTicketRuleMixin } from '@/mixins/entities/declare-ticket-rule';
import { permissionsTechnicalExploitationDeclareTicketRulesMixin } from '@/mixins/permissions/technical/exploitation/declare-ticket-rules';

import DeclareTicketRulesList from '@/components/other/declare-ticket/declare-ticket-rules-list.vue';

export default {
  components: {
    DeclareTicketRulesList,
  },
  mixins: [
    localQueryMixin,
    entitiesDeclareTicketRuleMixin,
    permissionsTechnicalExploitationDeclareTicketRulesMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    fetchList() {
      this.fetchDeclareTicketRulesList({ params: this.getQuery() });
    },

    showCreateDeclareTicketRuleModal() {
      this.$modals.show({
        name: MODALS.createDeclareTicketRule,
        config: {
          title: this.$t('modals.createDeclareTicketRule.create.title'),
          action: async (data) => {
            await this.createDeclareTicketRule({ data });

            this.fetchList();
          },
        },
      });
    },

    showEditDeclareTicketRuleModal(declareTicketRule) {
      this.$modals.show({
        name: MODALS.createDeclareTicketRule,
        config: {
          declareTicketRule,
          title: this.$t('modals.createDeclareTicketRule.edit.title'),
          action: async (data) => {
            await this.updateDeclareTicketRule({ id: declareTicketRule._id, data });

            this.fetchList();
          },
        },
      });
    },

    showDuplicateDeclareTicketRuleModal(declareTicketRule) {
      this.$modals.show({
        name: MODALS.createDeclareTicketRule,
        config: {
          declareTicketRule,
          title: this.$t('modals.createDeclareTicketRule.duplicate.title'),
          action: async (data) => {
            await this.createDeclareTicketRule({ data });

            this.fetchList();
          },
        },
      });
    },

    showDeleteDeclareTicketRuleModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.removeDeclareTicketRule({ id });

            this.fetchList();
          },
        },
      });
    },

    showDeleteSelectedDeclareTicketRulesModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.bulkRemoveDeclareTicketRules({
              data: selected.map(({ _id: id }) => ({ _id: id })),
            });

            return this.fetchList();
          },
        },
      });
    },
  },
};
</script>
