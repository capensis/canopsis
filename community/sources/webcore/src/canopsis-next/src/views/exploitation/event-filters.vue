<template>
  <c-page
    :creatable="hasCreateAnyEventFilterAccess"
    :create-tooltip="$t('modals.createEventFilter.create.title')"
    dark
    @create="showCreateRuleModal"
    @refresh="fetchList"
  >
    <event-filters-list
      :event-filters="eventFilters"
      :pending="eventFiltersPending"
      :total-items="eventFiltersMeta.total_count"
      :options.sync="options"
      :updatable="hasUpdateAnyEventFilterAccess"
      :removable="hasDeleteAnyEventFilterAccess"
      :duplicable="hasCreateAnyEventFilterAccess"
      @refresh="fetchList"
      @edit="showEditRuleModal"
      @duplicate="showDuplicateRuleModal"
      @remove="showDeleteRuleModal"
      @remove-selected="showDeleteSelectedRulesModal"
    />
  </c-page>
</template>

<script>
import { omit } from 'lodash';

import { MODALS } from '@/constants';

import { entitiesEventFilterMixin } from '@/mixins/entities/event-filter';
import {
  permissionsTechnicalExploitationEventFilterMixin,
} from '@/mixins/permissions/technical/exploitation/event-filter';
import { localQueryMixin } from '@/mixins/query-local/query';

import EventFiltersList from '@/components/other/event-filter/event-filters-list.vue';

export default {
  components: {
    EventFiltersList,
  },
  mixins: [
    localQueryMixin,
    entitiesEventFilterMixin,
    permissionsTechnicalExploitationEventFilterMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    showCreateRuleModal() {
      this.$modals.show({
        name: MODALS.createEventFilter,
        config: {
          action: data => this.createEventFilterWithPopup({ data }),
        },
      });
    },

    showDuplicateRuleModal(rule) {
      this.$modals.show({
        name: MODALS.createEventFilter,
        config: {
          title: this.$t('modals.createEventFilter.duplicate.title'),
          rule: omit(rule, ['_id']),
          action: data => this.duplicateEventFilterWithPopup({ data }),
        },
      });
    },

    showEditRuleModal(rule) {
      this.$modals.show({
        name: MODALS.createEventFilter,
        config: {
          rule,
          title: this.$t('modals.createEventFilter.edit.title'),
          isDisabledIdField: true,
          action: data => this.updateEventFilterWithPopup({ id: rule._id, data }),
        },
      });
    },

    showDeleteRuleModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeEventFilterWithPopup({ id }),
        },
      });
    },

    showDeleteSelectedRulesModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeSelectedEventFilterWithPopup(selected),
        },
      });
    },

    async createEventFilterWithPopup({ data }) {
      await this.createEventFilter({ data });
      this.$popups.success({ text: this.$t('modals.createEventFilter.create.success') });
      this.fetchList();
    },

    async duplicateEventFilterWithPopup({ data }) {
      await this.createEventFilter({ data });
      this.$popups.success({ text: this.$t('modals.createEventFilter.duplicate.success') });
      this.fetchList();
    },

    async updateEventFilterWithPopup({ id, data }) {
      await this.updateEventFilter({ id, data });
      this.$popups.success({ text: this.$t('modals.createEventFilter.edit.success') });
      this.fetchList();
    },

    async removeEventFilterWithPopup({ id }) {
      await this.removeEventFilter({ id });
      this.$popups.success({ text: this.$t('modals.createEventFilter.remove.success') });
      this.fetchList();
    },

    async removeSelectedEventFilterWithPopup(selected) {
      await Promise.all(selected.map(({ _id: id }) => this.removeEventFilter({ id })));
      this.$popups.success({ text: this.$t('modals.createEventFilter.remove.success') });
      this.fetchList();
    },

    async fetchList() {
      try {
        const params = this.getQuery();

        params.with_counts = true;

        await this.fetchEventFiltersList({ params });
      } catch (err) {
        console.error(err);

        this.$popups.error({ text: err.message || this.$t('errors.default') });
      }
    },
  },
};
</script>
