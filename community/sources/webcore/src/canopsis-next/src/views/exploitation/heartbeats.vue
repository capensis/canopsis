<template lang="pug">
  div
    c-page-header
    heartbeats-list(
      :pagination.sync="pagination",
      :heartbeats="heartbeats",
      :pending="heartbeatsPending",
      :total-items="heartbeatsMeta.total_count",
      @edit="showEditHeartbeatModal",
      @duplicate="showDuplicateHeartbeatModal",
      @remove="showDeleteHeartbeatModal",
      @remove-selected="showDeleteSelectedHeartbeatsModal"
    )
    c-fab-btn(
      :has-access="hasCreateAnyHeartbeatAccess",
      @refresh="refreshHeartbeatsList",
      @create="showCreateHeartbeatModal"
    )
      span {{ $t('modals.createHeartbeat.create.title') }}
</template>

<script>
import { MODALS } from '@/constants';

import entitiesHeartbeatMixin from '@/mixins/entities/heartbeat';
import { permissionsTechnicalExploitationHeartbeatMixin } from '@/mixins/permissions/technical/exploitation/heartbeat';
import { localQueryMixin } from '@/mixins/query-local/query';

import HeartbeatsList from '@/components/other/heartbeat/exploitation/heartbeats-list.vue';

export default {
  components: {
    HeartbeatsList,
  },
  mixins: [
    localQueryMixin,
    entitiesHeartbeatMixin,
    permissionsTechnicalExploitationHeartbeatMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    showCreateHeartbeatModal() {
      this.$modals.show({
        name: MODALS.createHeartbeat,
        config: {
          action: data => this.createHeartbeatWithPopup({ data }),
        },
      });
    },

    showEditHeartbeatModal(heartbeat) {
      this.$modals.show({
        name: MODALS.createHeartbeat,
        config: {
          heartbeat,
          action: data => this.updateHeartbeatWithPopup({ id: heartbeat._id, data }),
        },
      });
    },

    showDuplicateHeartbeatModal(heartbeat) {
      this.$modals.show({
        name: MODALS.createHeartbeat,
        config: {
          heartbeat,

          isDuplicating: true,
          action: data => this.createHeartbeatWithPopup({ data }),
        },
      });
    },

    showDeleteHeartbeatModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeHeartbeatWithPopup({ id }),
        },
      });
    },

    showDeleteSelectedHeartbeatsModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeSelectedHeartbeatsWithPopup(selected),
        },
      });
    },

    async createHeartbeatWithPopup({ data }) {
      await this.createHeartbeat({ data });
      this.$popups.success({ text: this.$t('modals.createHeartbeat.create.success') });
      this.refreshHeartbeatsList();
    },

    async updateHeartbeatWithPopup({ id, data }) {
      await this.updateHeartbeat({ id, data });
      this.$popups.success({ text: this.$t('modals.createHeartbeat.edit.success') });
      this.refreshHeartbeatsList();
    },

    async removeHeartbeatWithPopup({ id }) {
      await this.removeHeartbeat({ id });
      this.$popups.success({ text: this.$t('modals.createHeartbeat.remove.success') });
      this.refreshHeartbeatsList();
    },

    async removeSelectedHeartbeatsWithPopup(selected) {
      await Promise.all(selected.map(({ _id: id }) => this.removeHeartbeat({ id })));
      this.$popups.success({ text: this.$t('modals.createHeartbeat.remove.success') });
      this.refreshHeartbeatsList();
    },

    fetchList() {
      const { sort_dir: sort, ...query } = this.getQuery();
      // TODO: remove that after backend fixes
      if (sort) {
        query.sort = sort.toLocaleLowerCase();
      }

      this.fetchHeartbeatsList({ params: query });
    },
  },
};
</script>
