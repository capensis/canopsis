<template>
  <div>
    <c-page-header />
    <v-card class="ma-4 mt-0">
      <alarm-status-rules-list
        :options.sync="options"
        :rules="flappingRules"
        :total-items="flappingRulesMeta.total_count"
        :pending="flappingRulesPending"
        :updatable="hasUpdateAnyFlappingRuleAccess"
        :removable="hasDeleteAnyFlappingRuleAccess"
        :duplicable="hasCreateAnyFlappingRuleAccess"
        flapping
        @edit="showEditFlappingRuleModal"
        @duplicate="showDuplicateFlappingRuleModal"
        @remove="showDeleteFlappingRuleModal"
        @remove-selected="showDeleteSelectedFlappingRulesModal"
      />
    </v-card>
    <c-fab-btn
      :has-access="hasCreateAnyFlappingRuleAccess"
      dark
      @refresh="fetchList"
      @create="showCreateFlappingRuleModal"
    >
      <span>{{ $t('modals.createAlarmStatusRule.flapping.create.title') }}</span>
    </c-fab-btn>
  </div>
</template>

<script>
import { MODALS } from '@/constants';

import { localQueryMixin } from '@/mixins/query-local/query';
import { entitiesFlappingRulesMixin } from '@/mixins/entities/flapping-rules';
import {
  permissionsTechnicalExploitationFlappingRulesMixin,
} from '@/mixins/permissions/technical/exploitation/flapping-rules';

import AlarmStatusRulesList from '@/components/other/alarm-status-rule/alarm-status-rules-list.vue';

export default {
  components: {
    AlarmStatusRulesList,
  },
  mixins: [
    localQueryMixin,
    entitiesFlappingRulesMixin,
    permissionsTechnicalExploitationFlappingRulesMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    fetchList() {
      this.fetchFlappingRulesList({ params: this.getQuery() });
    },

    showCreateFlappingRuleModal() {
      this.$modals.show({
        name: MODALS.createAlarmStatusRule,
        config: {
          title: this.$t('modals.createAlarmStatusRule.flapping.create.title'),
          flapping: true,
          action: async (data) => {
            await this.createFlappingRule({ data });

            return this.fetchList();
          },
        },
      });
    },

    showEditFlappingRuleModal(rule) {
      this.$modals.show({
        name: MODALS.createAlarmStatusRule,
        config: {
          rule,

          title: this.$t('modals.createAlarmStatusRule.flapping.edit.title'),
          flapping: true,
          action: async (data) => {
            await this.updateFlappingRule({ id: rule._id, data });

            return this.fetchList();
          },
        },
      });
    },

    showDuplicateFlappingRuleModal(rule) {
      this.$modals.show({
        name: MODALS.createAlarmStatusRule,
        config: {
          rule,

          title: this.$t('modals.createAlarmStatusRule.flapping.duplicate.title'),
          flapping: true,
          action: async (data) => {
            await this.createFlappingRule({ data });

            return this.fetchList();
          },
        },
      });
    },

    showDeleteFlappingRuleModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.removeFlappingRule({ id });

            return this.fetchList();
          },
        },
      });
    },

    showDeleteSelectedFlappingRulesModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await Promise.all(selected.map(({ _id: id }) => this.removeFlappingRule({ id })));

            return this.fetchList();
          },
        },
      });
    },
  },
};
</script>
