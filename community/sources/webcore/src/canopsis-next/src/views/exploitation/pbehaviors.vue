<template>
  <div>
    <c-page-header />
    <v-card class="ma-4 mt-0">
      <pbehaviors-list
        :pagination.sync="pagination"
        :pbehaviors="pbehaviors"
        :total-items="pbehaviorsMeta.total_count"
        :pending="pbehaviorsPending"
        :updatable="hasUpdateAnyPbehaviorAccess"
        :removable="hasDeleteAnyPbehaviorAccess"
        :duplicable="hasCreateAnyPbehaviorAccess"
        :enablable="hasUpdateAnyPbehaviorAccess"
        :disablable="hasUpdateAnyPbehaviorAccess"
        @edit="showEditPbehaviorModal"
        @duplicate="showDuplicatePbehaviorModal"
        @remove="showDeletePbehaviorModal"
      />
    </v-card>
    <c-fab-btn
      :has-access="hasCreateAnyPbehaviorAccess"
      @refresh="fetchList"
      @create="showCreatePbehaviorModal"
    >
      <span>{{ $t('common.addPbehavior') }}</span>
    </c-fab-btn>
  </div>
</template>

<script>
import { MODALS } from '@/constants';

import { entitiesPbehaviorMixin } from '@/mixins/entities/pbehavior';
import { permissionsTechnicalExploitationPbehaviorMixin } from '@/mixins/permissions/technical/exploitation/pbehavior';
import { localQueryMixin } from '@/mixins/query-local/query';

import PbehaviorsList from '@/components/other/pbehavior/pbehaviors/pbehaviors-list.vue';

export default {
  components: {
    PbehaviorsList,
  },
  mixins: [
    localQueryMixin,
    entitiesPbehaviorMixin,
    permissionsTechnicalExploitationPbehaviorMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    showCreatePbehaviorModal() {
      this.$modals.show({
        name: MODALS.pbehaviorPlanning,
        config: {
          afterSubmit: this.fetchList,
        },
      });
    },

    showEditPbehaviorModal(pbehavior) {
      this.$modals.show({
        name: MODALS.pbehaviorPlanning,
        config: {
          pbehaviors: [pbehavior],
          afterSubmit: this.fetchList,
        },
      });
    },

    showDuplicatePbehaviorModal(pbehavior) {
      this.$modals.show({
        name: MODALS.pbehaviorPlanning,
        config: {
          pbehaviorsToAdd: [pbehavior],
          afterSubmit: this.fetchList,
        },
      });
    },

    showDeletePbehaviorModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.removePbehavior({ id });
            await this.fetchList();
          },
        },
      });
    },

    fetchList() {
      const params = this.getQuery();

      params.with_flags = true;

      this.fetchPbehaviorsList({ params });
    },
  },
};
</script>
