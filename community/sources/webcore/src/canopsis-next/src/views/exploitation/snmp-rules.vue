<template>
  <div class="snmp-rule-wrapper">
    <c-page-header />
    <v-card class="ma-4 mt-0">
      <snmp-rules-list
        :options.sync="options"
        :items="snmpRules"
        :total-items="snmpRulesMeta.total_count"
        :pending="snmpRulesPending"
        :duplicable="hasCreateAnySnmpRuleAccess"
        :removable="hasDeleteAnySnmpRuleAccess"
        :updatable="hasUpdateAnySnmpRuleAccess"
        @edit="showEditSnmpRuleModal"
        @remove="showDeleteSnmpRuleModal"
        @duplicate="showDuplicateSnmpRuleModal"
        @remove-selected="showDeleteSelectedSnmpRulesModal"
      />
    </v-card>
    <c-fab-expand-btn
      :has-access="hasCreateAnySnmpRuleAccess || hasUpdateAnySnmpRuleAccess"
      @refresh="fetchList"
    >
      <template #icons="">
        <v-icon>menu</v-icon>
        <v-icon>close</v-icon>
      </template>
      <snmp-rules-upload-button v-if="hasUpdateAnySnmpRuleAccess" />
      <c-action-fab-btn
        v-if="hasCreateAnySnmpRuleAccess"
        :tooltip="$t('snmpRule.addSnmpRule')"
        color="primary"
        icon="add"
        top
        @click="showCreateSnmpRuleModal"
      />
    </c-fab-expand-btn>
  </div>
</template>

<script>
import { omit } from 'lodash';

import { MODALS } from '@/constants';

import { localQueryMixin } from '@/mixins/query/query';
import { entitiesSnmpRuleMixin } from '@/mixins/entities/snmp-rule';
import { permissionsTechnicalExploitationSnmpRuleMixin } from '@/mixins/permissions/technical/exploitation/snmp-rule';

import SnmpRulesUploadButton from '@/components/other/snmp-rule/partials/snmp-rules-list-upload-button.vue';
import SnmpRulesList from '@/components/other/snmp-rule/snmp-rules-list.vue';

export default {
  components: {
    SnmpRulesUploadButton,
    SnmpRulesList,
  },
  mixins: [
    entitiesSnmpRuleMixin,
    localQueryMixin,
    permissionsTechnicalExploitationSnmpRuleMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    showCreateSnmpRuleModal() {
      this.$modals.show({
        name: MODALS.createSnmpRule,
        config: {
          action: async (data) => {
            await this.createSnmpRule({ data });
            this.fetchList();
          },
        },
      });
    },

    showDuplicateSnmpRuleModal(snmpRule) {
      this.$modals.show({
        name: MODALS.createSnmpRule,
        config: {
          snmpRule: omit(snmpRule, ['_id']),
          title: this.$t('modals.createSnmpRule.duplicate.title'),
          action: async (data) => {
            await this.createSnmpRule({ data });
            this.fetchList();
          },
        },
      });
    },

    showEditSnmpRuleModal(snmpRule) {
      this.$modals.show({
        name: MODALS.createSnmpRule,
        config: {
          snmpRule,

          title: this.$t('modals.createSnmpRule.edit.title'),
          action: async (data) => {
            await this.updateSnmpRule({ id: snmpRule._id, data });

            return this.fetchList();
          },
        },
      });
    },

    showDeleteSnmpRuleModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.removeSnmpRule({ id });

            return this.fetchList();
          },
        },
      });
    },

    showDeleteSelectedSnmpRulesModal(selected = []) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await Promise.all(selected.map(({ _id: id }) => this.removeSnmpRule({ id })));

            return this.fetchList();
          },
        },
      });
    },

    fetchList() {
      this.fetchSnmpRulesList({ params: this.getQuery() });
    },
  },
};
</script>

<style lang="scss" scoped>
.snmp-rule-wrapper {
  padding-bottom: 70px;
}
</style>
