<template lang="pug">
  div
    c-page-header
    v-card.ma-4.mt-0
      snmp-rules-list(
        :pagination.sync="pagination",
        :items="snmpRules",
        :total-items="snmpRulesMeta.total",
        :pending="snmpRulesPending",
        :duplicable="hasCreateAnySnmpRuleAccess",
        :removable="hasDeleteAnySnmpRuleAccess",
        :updatable="hasUpdateAnySnmpRuleAccess",
        @edit="showEditSnmpRuleModal",
        @remove="showDeleteSnmpRuleModal",
        @duplicate="showDuplicateSnmpRuleModal",
        @remove-selected="showDeleteSelectedSnmpRulesModal"
      )
    c-fab-expand-btn(
      :has-access="hasCreateAnySnmpRuleAccess || hasUpdateAnySnmpRuleAccess",
      @refresh="fetchList"
    )
      template(#icons="")
        v-icon menu
        v-icon close
      snmp-rules-upload-button(v-if="hasUpdateAnySnmpRuleAccess")
      c-action-fab-btn(
        v-if="hasCreateAnySnmpRuleAccess",
        :tooltip="$t('snmpRule.addSnmpRule')",
        color="primary",
        icon="add",
        small,
        top,
        @click="showCreateSnmpRuleModal"
      )
</template>

<script>
import { omit } from 'lodash';

import { MODALS } from '@/constants';

import { localQueryMixin } from '@/mixins/query-local/query';
import { entitiesSnmpRuleMixin } from '@/mixins/entities/snmp-rule';
import { permissionsTechnicalExploitationSnmpRuleMixin } from '@/mixins/permissions/technical/exploitation/snmp-rule';

import SnmpRulesUploadButton from '@/components/other/snmp-rule/exploitation/snmp-rules-list-upload-button.vue';
import SnmpRulesList from '@/components/other/snmp-rule/exploitation/snmp-rules-list.vue';

export default {
  components: {
    SnmpRulesUploadButton,
    SnmpRulesList,
  },
  mixins: [
    entitiesSnmpRuleMixin,
    localQueryMixin,
    permissionsTechnicalExploitationSnmpRuleMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    showCreateSnmpRuleModal() {
      this.$modals.show({
        name: MODALS.createSnmpRule,
        config: {
          action: async (data) => {
            await this.createSnmpRule({ data });
            this.fetchList();
          },
        },
      });
    },

    showDuplicateSnmpRuleModal(snmpRule) {
      this.$modals.show({
        name: MODALS.createSnmpRule,
        config: {
          snmpRule: omit(snmpRule, ['_id']),

          action: async (data) => {
            await this.createSnmpRule({ data });
            this.fetchList();
          },
        },
      });
    },

    showEditSnmpRuleModal(snmpRule) {
      this.$modals.show({
        name: MODALS.createSnmpRule,
        config: {
          snmpRule,

          action: async (data) => {
            await this.createSnmpRule({ data });

            return this.fetchList();
          },
        },
      });
    },

    showDeleteSnmpRuleModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.removeSnmpRule({ data: { ids: [id] } });

            return this.fetchList();
          },
        },
      });
    },

    showDeleteSelectedSnmpRulesModal(selected = []) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.removeSnmpRule({ data: { ids: selected.map(({ _id: id }) => id) } });

            return this.fetchList();
          },
        },
      });
    },

    getQuery() {
      return {
        limit: this.query.rowsPerPage,
        start: (this.query.page - 1) * this.query.rowsPerPage,
      };
    },

    fetchList() {
      this.fetchSnmpRulesList({ params: this.getQuery() });
    },
  },
};
</script>
