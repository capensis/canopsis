<template>
  <div>
    <c-page-header />
    <v-card class="ma-4 mt-0">
      <dynamic-infos-list
        :dynamic-infos="dynamicInfos"
        :pending="dynamicInfosPending"
        :options.sync="options"
        :total-items="dynamicInfosMeta.total_count"
        :duplicable="hasCreateAnyDynamicInformationAccess"
        :updatable="hasUpdateAnyDynamicInformationAccess"
        :removable="hasDeleteAnyDynamicInformationAccess"
        @edit="showEditDynamicInfoModal"
        @duplicate="showDuplicateDynamicInfoModal"
        @remove="showDeleteDynamicInfoModal"
        @remove-selected="showDeleteSelectedDynamicInfosModal"
      />
    </v-card>
    <c-fab-expand-btn
      @refresh="fetchList"
      :has-access="hasCreateAnyDynamicInformationAccess"
    >
      <c-action-fab-btn
        :tooltip="$t('modals.dynamicInfoTemplatesList.title')"
        color="indigo"
        icon="library_books"
        top
        @click="showDynamicInfoTemplatesModal"
      />
      <c-action-fab-btn
        :tooltip="$t('modals.createDynamicInfo.create.title')"
        color="deep-purple"
        icon="assignment"
        top
        @click="showCreateDynamicInfoModal"
      />
    </c-fab-expand-btn>
  </div>
</template>

<script>
import { omit } from 'lodash';

import { MODALS } from '@/constants';

import { entitiesDynamicInfoMixin } from '@/mixins/entities/dynamic-info';
import {
  permissionsTechnicalExploitationDynamicInformationMixin,
} from '@/mixins/permissions/technical/exploitation/dynamic-information';
import { localQueryMixin } from '@/mixins/query-local/query';

import DynamicInfosList from '@/components/other/dynamic-info/dynamic-infos-list.vue';

export default {
  components: {
    DynamicInfosList,
  },
  mixins: [
    localQueryMixin,
    entitiesDynamicInfoMixin,
    permissionsTechnicalExploitationDynamicInformationMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    showDynamicInfoTemplatesModal() {
      this.$modals.show({
        name: MODALS.dynamicInfoTemplatesList,
        config: {
          action: data => this.createDynamicInfoWithPopup({ data }),
        },
      });
    },

    showCreateDynamicInfoModal() {
      this.$modals.show({
        name: MODALS.createDynamicInfo,
        config: {
          action: data => this.createDynamicInfoWithPopup({ data }),
        },
      });
    },

    showEditDynamicInfoModal(dynamicInfo) {
      this.$modals.show({
        name: MODALS.createDynamicInfo,
        config: {
          dynamicInfo,
          isDisabledIdField: true,
          title: this.$t('modals.createDynamicInfo.edit.title'),
          action: data => this.updateDynamicInfoWithPopup({ id: dynamicInfo._id, data }),
        },
      });
    },

    showDuplicateDynamicInfoModal(dynamicInfo) {
      this.$modals.show({
        name: MODALS.createDynamicInfo,
        config: {
          dynamicInfo: omit(dynamicInfo, ['_id']),

          title: this.$t('modals.createDynamicInfo.duplicate.title'),
          action: data => this.createDynamicInfoWithPopup({ data }),
        },
      });
    },

    showDeleteDynamicInfoModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeDynamicInfoWithPopup({ id }),
        },
      });
    },

    showDeleteSelectedDynamicInfosModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeSelectedDynamicInfosWithPopup(selected),
        },
      });
    },

    async createDynamicInfoWithPopup({ data }) {
      const { alarm_update: alarmUpdate } = await this.createDynamicInfo({ data });
      const alarmUpdateText = alarmUpdate ? ` ${this.$t('modals.createDynamicInfo.alarmUpdate')}` : '';

      this.$popups.success({
        text: `${this.$t('modals.createDynamicInfo.create.success')}${alarmUpdateText}`,
      });

      this.fetchList();
    },

    async updateDynamicInfoWithPopup({ id, data }) {
      const { alarm_update: alarmUpdate } = await this.updateDynamicInfo({ id, data });
      const alarmUpdateText = alarmUpdate ? ` ${this.$t('modals.createDynamicInfo.alarmUpdate')}` : '';

      this.$popups.success({
        text: `${this.$t('modals.createDynamicInfo.edit.success')}${alarmUpdateText}`,
      });

      this.fetchList();
    },

    async removeDynamicInfoWithPopup({ id }) {
      await this.removeDynamicInfo({ id });
      this.$popups.success({ text: this.$t('modals.createDynamicInfo.remove.success') });

      this.fetchList();
    },

    async removeSelectedDynamicInfosWithPopup(selected) {
      await Promise.all(selected.map(({ _id: id }) => this.removeDynamicInfo({ id })));
      this.$popups.success({ text: this.$t('modals.createDynamicInfo.remove.success') });

      this.fetchList();
    },

    fetchList() {
      this.fetchDynamicInfosList({ params: this.getQuery() });
    },
  },
};
</script>
