<template lang="pug">
  div
    c-page-header
    dynamic-infos-list(
      :dynamic-infos="dynamicInfos",
      :pending="dynamicInfosPending",
      :pagination.sync="pagination",
      :total-items="dynamicInfosMeta.total_count",
      @edit="showEditDynamicInfoModal",
      @duplicate="showDuplicateDynamicInfoModal",
      @remove="showDeleteDynamicInfoModal",
      @remove-selected="showDeleteSelectedDynamicInfosModal"
    )
    c-fab-expand-btn(@refresh="fetchList", :has-access="hasCreateAnyDynamicInformationAccess")
      v-tooltip(top)
        v-btn(slot="activator", color="indigo", fab, dark, small, @click.stop="showDynamicInfoTemplatesModal")
          v-icon library_books
        span {{ $t('modals.dynamicInfoTemplatesList.title') }}
      v-tooltip(top)
        v-btn(slot="activator", color="deep-purple", small, dark, fab, icon, @click="showCreateDynamicInfoModal")
          v-icon assignment
        span {{ $t('modals.createDynamicInfo.create.title') }}
</template>

<script>
import { omit } from 'lodash';

import { MODALS } from '@/constants';

import { entitiesDynamicInfoMixin } from '@/mixins/entities/dynamic-info';
import {
  permissionsTechnicalExploitationDynamicInformationMixin,
} from '@/mixins/permissions/technical/exploitation/dynamic-information';
import { localQueryMixin } from '@/mixins/query-local/query';

import DynamicInfosList from '@/components/other/dynamic-info/exploitation/dynamic-infos-list.vue';

export default {
  components: {
    DynamicInfosList,
  },
  mixins: [
    localQueryMixin,
    entitiesDynamicInfoMixin,
    permissionsTechnicalExploitationDynamicInformationMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    showDynamicInfoTemplatesModal() {
      this.$modals.show({
        name: MODALS.dynamicInfoTemplatesList,
        config: {
          action: data => this.createDynamicInfoWithPopup({ data }),
        },
      });
    },

    showCreateDynamicInfoModal() {
      this.$modals.show({
        name: MODALS.createDynamicInfo,
        config: {
          action: data => this.createDynamicInfoWithPopup({ data }),
        },
      });
    },

    showEditDynamicInfoModal(dynamicInfo) {
      this.$modals.show({
        name: MODALS.createDynamicInfo,
        config: {
          dynamicInfo,
          isDisabledIdField: true,
          title: this.$t('modals.createDynamicInfo.edit.title'),
          action: data => this.updateDynamicInfoWithPopup({ id: dynamicInfo._id, data }),
        },
      });
    },

    showDuplicateDynamicInfoModal(dynamicInfo) {
      this.$modals.show({
        name: MODALS.createDynamicInfo,
        config: {
          dynamicInfo: omit(dynamicInfo, ['_id']),

          title: this.$t('modals.createDynamicInfo.duplicate.title'),
          action: data => this.createDynamicInfoWithPopup({ data }),
        },
      });
    },

    showDeleteDynamicInfoModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeDynamicInfoWithPopup({ id }),
        },
      });
    },

    showDeleteSelectedDynamicInfosModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeSelectedDynamicInfosWithPopup(selected),
        },
      });
    },

    async createDynamicInfoWithPopup({ data }) {
      await this.createDynamicInfo({ data });
      this.$popups.success({ text: this.$t('modals.createDynamicInfo.create.success') });

      this.fetchList();
    },

    async updateDynamicInfoWithPopup({ id, data }) {
      await this.updateDynamicInfo({ id, data });
      this.$popups.success({ text: this.$t('modals.createDynamicInfo.edit.success') });

      this.fetchList();
    },

    async removeDynamicInfoWithPopup({ id }) {
      await this.removeDynamicInfo({ id });
      this.$popups.success({ text: this.$t('modals.createDynamicInfo.remove.success') });

      this.fetchList();
    },

    async removeSelectedDynamicInfosWithPopup(selected) {
      await Promise.all(selected.map(({ _id: id }) => this.removeDynamicInfo({ id })));
      this.$popups.success({ text: this.$t('modals.createDynamicInfo.remove.success') });

      this.fetchList();
    },

    fetchList() {
      this.fetchDynamicInfosList({ params: this.getQuery() });
    },
  },
};
</script>
