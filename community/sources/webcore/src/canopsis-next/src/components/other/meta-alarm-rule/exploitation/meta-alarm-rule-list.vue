<template lang="pug">
  c-advanced-data-table.white(
    :items="rules",
    :headers="headers",
    :loading="pending",
    :total-items="totalItems",
    :pagination="pagination",
    :is-expandable-item="hasRulePatterns",
    select-all,
    expand,
    search,
    advanced-pagination,
    @update:pagination="$emit('update:pagination', $event)"
  )
    template(slot="toolbar", slot-scope="props")
      v-flex(v-show="hasDeleteAnyMetaAlarmRuleAccess && props.selected.length", xs4)
        c-action-btn(type="delete", @click="$emit('remove-selected', props.selected)")
    template(slot="auto_resolve", slot-scope="props")
      c-enabled(:value="props.item.auto_resolve")
    template(slot="config.threshold_rate", slot-scope="props") {{ props.item | getThresholdRatePercent }}
    template(slot="config.threshold_count", slot-scope="props") {{ props.item | get('config.threshold_count') }}
    template(slot="config.time_interval", slot-scope="props") {{ props.item | get('config.time_interval') | duration }}
    template(slot="created", slot-scope="props") {{ props.item.created | date }}
    template(slot="updated", slot-scope="props") {{ props.item.updated | date }}
    template(slot="actions", slot-scope="props")
      v-layout(row)
        c-action-btn(
          v-if="hasUpdateAnyMetaAlarmRuleAccess",
          type="edit",
          @click="$emit('edit', props.item)"
        )
        c-action-btn(
          v-if="hasCreateAnyMetaAlarmRuleAccess",
          type="duplicate",
          @click="$emit('duplicate', props.item)"
        )
        c-action-btn(
          v-if="hasDeleteAnyMetaAlarmRuleAccess",
          type="delete",
          @click="$emit('remove', props.item._id)"
        )
    template(slot="expand", slot-scope="props")
      meta-alarm-rule-list-expand-panel(:meta-alarm-rule="props.item")
</template>

<script>
import { get } from 'lodash';

import {
  permissionsTechnicalExploitationMetaAlarmRuleMixin,
} from '@/mixins/permissions/technical/exploitation/meta-alarm-rule';

import { META_ALARMS_RULE_TYPES } from '@/constants';

import { convertNumberToRoundedPercentString } from '@/helpers/string';

import MetaAlarmRuleListExpandPanel from './partials/meta-alarm-rule-list-expand-panel.vue';

export default {
  components: {
    MetaAlarmRuleListExpandPanel,
  },
  filters: {
    getThresholdRatePercent({ config }) {
      const thresholdRate = get(config, 'threshold_rate');

      return thresholdRate && convertNumberToRoundedPercentString(thresholdRate);
    },
  },
  mixins: [
    permissionsTechnicalExploitationMetaAlarmRuleMixin,
  ],
  props: {
    rules: {
      type: Array,
      default: () => [],
    },
    pending: {
      type: Boolean,
      default: true,
    },
    totalItems: {
      type: Number,
      required: false,
    },
    pagination: {
      type: Object,
      required: true,
    },
  },
  computed: {
    headers() {
      return [
        {
          text: this.$t('common.id'),
          value: '_id',
        },
        {
          text: this.$t('common.name'),
          value: 'name',
        },
        {
          text: this.$t('common.type'),
          value: 'type',
        },
        {
          text: this.$t('metaAlarmRule.autoResolve'),
          value: 'auto_resolve',
          sortable: false,
        },
        {
          text: this.$t('metaAlarmRule.thresholdRate'),
          value: 'config.threshold_rate',
          sortable: false,
        },
        {
          text: this.$t('metaAlarmRule.thresholdCount'),
          value: 'config.threshold_count',
          sortable: false,
        },
        {
          text: this.$t('metaAlarmRule.timeInterval'),
          value: 'config.time_interval',
          sortable: false,
        },
        {
          text: this.$t('common.author'),
          value: 'author',
        },
        {
          text: this.$t('common.created'),
          value: 'created',
        },
        {
          text: this.$t('common.updated'),
          value: 'updated',
        },
        {
          text: this.$t('common.actionsLabel'),
          value: 'actions',
          sortable: false,
        },
      ];
    },
  },
  methods: {
    hasRulePatterns({ type }) {
      return type === META_ALARMS_RULE_TYPES.attribute
        || type === META_ALARMS_RULE_TYPES.complex
        || type === META_ALARMS_RULE_TYPES.corel;
    },
  },
};
</script>
