<template lang="pug">
  div
    v-alert(:value="hasAnyError", type="error") {{ errorMessages }}
    v-layout(justify-end)
      v-btn.primary(fab, small, flat, @click="showAddInfoModal")
        v-icon add
    v-data-table(
      :headers="headers",
      :items="form",
      :no-data-text="$t('tables.noData')",
      item-key="key"
    )
      template(#items="{ item }")
        tr
          td {{ item.name }}
          td {{ item.value }}
          td
            v-layout(row)
              c-action-btn(type="edit", @click="showEditInfoModal(item)")
              c-action-btn(type="delete", @click="removeInfo(item)")
</template>

<script>
import { MODALS } from '@/constants';

import { formArrayMixin, formValidationHeaderMixin } from '@/mixins/form';

export default {
  inject: ['$validator'],
  mixins: [formArrayMixin, formValidationHeaderMixin],
  model: {
    prop: 'form',
    event: 'input',
  },
  props: {
    form: {
      type: Array,
      required: true,
    },
    name: {
      type: String,
      default: 'infos',
    },
  },
  computed: {
    errorMessages() {
      return this.errors.collect(this.name)?.join('\n');
    },

    headers() {
      return [
        { text: this.$t('common.name'), value: 'name' },
        { text: this.$t('common.value'), value: 'value' },
        { text: this.$t('common.actionsLabel'), value: 'actions' },
      ];
    },
  },
  watch: {
    form() {
      this.$validator.validate(this.name);
    },
  },
  created() {
    this.attachRequiredRule();
  },
  beforeDestroy() {
    this.detachRequiredRule();
  },
  methods: {
    attachRequiredRule() {
      this.$validator.attach({
        name: this.name,
        rules: 'required:true',
        getter: () => !!this.form.length,
        context: () => this,
        vm: this,
      });
    },

    detachRequiredRule() {
      this.$validator.detach(this.name);
    },

    findInfoIndex(info = {}) {
      return this.form.findIndex(({ name }) => name === info.name);
    },

    showAddInfoModal() {
      this.$modals.show({
        name: MODALS.createDynamicInfoInformation,
        config: {
          existingNames: this.form.map(info => info.name),
          action: newInfo => this.addItemIntoArray(newInfo),
        },
      });
    },

    showEditInfoModal(info) {
      this.$modals.show({
        name: MODALS.createDynamicInfoInformation,
        config: {
          info,

          existingNames: this.form.map(({ name }) => name),
          action: (newInfo) => {
            const index = this.findInfoIndex(info);

            this.updateItemInArray(index, newInfo);
          },
        },
      });
    },

    removeInfo(info) {
      const index = this.findInfoIndex(info);

      this.removeItemFromArray(index);
    },
  },
};
</script>
