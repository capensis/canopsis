<template lang="pug">
  div(@touchend.stop)
    limited-time-line-chart.text--primary(:datasets="datasets", :options="lastHoursChartOptions")
</template>

<script>
import { COLORS } from '@/config';
import { DATETIME_FORMATS, QUICK_RANGES } from '@/constants';

import { entitiesMessageRateStatsMixin } from '@/mixins/entities/message-rate-stats';
import { localQueryMixin } from '@/mixins/query-local/query';

import LimitedTimeLineChart from '@/components/common/chart/limited-time-line-chart.vue';

export default {
  inject: ['$system'],
  components: { LimitedTimeLineChart },
  mixins: [entitiesMessageRateStatsMixin, localQueryMixin],
  props: {
    maxQueueLength: {
      type: Number,
      required: true,
    },
  },
  data() {
    return {
      pending: false,
      messagesStats: [],
      deletedBefore: 0,
      query: {
        interval: {
          from: QUICK_RANGES.last1Hour.start,
          to: QUICK_RANGES.last1Hour.stop,
        },
      },
    };
  },
  computed: {
    datasets() {
      return [{
        backgroundColor: 'rgba(90, 109, 128, 0.7)',
        fill: true,
        data: this.messagesStats.map(({ _id: time, received }) => ({
          x: time * 1000,
          y: received,
        })),
      }];
    },

    lastHoursChartOptions() {
      return {
        animation: false,
        scales: {
          x: {
            time: {
              tooltipFormat: DATETIME_FORMATS.timePicker,
              displayFormats: {
                year: DATETIME_FORMATS.timePicker,
                quarter: DATETIME_FORMATS.timePicker,
                month: DATETIME_FORMATS.timePicker,
                week: DATETIME_FORMATS.timePicker,
                day: DATETIME_FORMATS.timePicker,
                hour: DATETIME_FORMATS.timePicker,
                minute: DATETIME_FORMATS.timePicker,
                second: DATETIME_FORMATS.timePicker,
              },
            },
          },
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: tooltip => `${tooltip.formattedValue} ${this.$t('healthcheck.messagesPerHour')}`,
            },
          },
          limit: {
            enabled: true,
            scaleID: 'x',
            value: this.maxQueueLength,
            backgroundColor: COLORS.healthcheck.error,
            borderWidth: 1,
          },
        },
      };
    },
  },
  mounted() {
    this.fetchList();
  },
  methods: {
    async fetchList() {
      this.pending = true;

      // fetch last messages

      this.pending = false;
    },
  },
};
</script>
