<template lang="pug">
  div.canvas-wrapper(ref="canvasWrapper")
</template>

<script>
import { minBy } from 'lodash';
import cytoscape from 'cytoscape';
import cytoscapeNodeHtmlLabel from 'cytoscape-node-html-label';
import cytoscapeDagre from 'cytoscape-dagre';

import { COLORS } from '@/config';
import { HEALTHCHECK_SERVICES_NAMES, HEALTHCHECK_ENGINES_NAMES, HEALTHCHECK_STATUSES, CAT_ENGINES } from '@/constants';

const SPACING_FACTOR = 2;
const NODES_SPACE = 85;
const FIT_PADDING = 15;

const getDiff = (factor = 0) => NODES_SPACE * SPACING_FACTOR * factor;

const HEALTHCHECK_SERVICES_RENDERED_POSITIONS_DIFF = {
  [HEALTHCHECK_SERVICES_NAMES.events]: { x: getDiff(-3), y: getDiff(1) },
  [HEALTHCHECK_SERVICES_NAMES.mongo]: { x: getDiff(-3), y: 0 },
  [HEALTHCHECK_SERVICES_NAMES.api]: { x: getDiff(-2), y: 0 },
  [HEALTHCHECK_SERVICES_NAMES.rabbit]: { x: getDiff(-2), y: getDiff(1) },
  [HEALTHCHECK_SERVICES_NAMES.healthcheck]: { x: getDiff(-2), y: getDiff(-0.5) },
  [HEALTHCHECK_SERVICES_NAMES.redis]: { x: getDiff(-1), y: 0 },
  [HEALTHCHECK_SERVICES_NAMES.enginesChain]: { x: 0, y: getDiff(-0.5) },
};

cytoscapeNodeHtmlLabel(cytoscape);
cytoscape.use(cytoscapeDagre);

export default {
  props: {
    services: {
      type: Array,
      default: () => [],
    },
    engines: {
      type: Object,
      default: () => ({}),
    },
  },
  computed: {
    servicesNodes() {
      return [
        {
          classes: ['without-node'],
          data: { id: HEALTHCHECK_SERVICES_NAMES.events },
        },
        {
          classes: ['service-title-bottom'],
          data: { id: HEALTHCHECK_SERVICES_NAMES.mongo, color: COLORS.primary },
        },
        {
          classes: ['without-node'],
          data: { id: HEALTHCHECK_SERVICES_NAMES.healthcheck },
        },
        {
          data: { id: HEALTHCHECK_SERVICES_NAMES.api, color: COLORS.primary },
        },
        {
          classes: ['service-title-bottom'],
          data: { id: HEALTHCHECK_SERVICES_NAMES.rabbit, color: COLORS.primary },
        },
        {
          classes: ['service-title-bottom'],
          data: { id: HEALTHCHECK_SERVICES_NAMES.redis, color: COLORS.primary },
        },
        {
          locked: true,
          classes: ['without-node', 'without-node__error'],
          data: { id: HEALTHCHECK_SERVICES_NAMES.enginesChain },
        },
      ];
    },

    servicesEdges() {
      return [
        {
          data: {
            source: HEALTHCHECK_SERVICES_NAMES.mongo,
            target: HEALTHCHECK_SERVICES_NAMES.api,
            label: 'Status check',
            color: 'gray',
          },
        },
        {
          data: {
            source: HEALTHCHECK_SERVICES_NAMES.events,
            target: HEALTHCHECK_SERVICES_NAMES.rabbit,
            color: 'black',
          },
        },
        {
          classes: ['service-edge__vertical'],
          data: {
            source: HEALTHCHECK_SERVICES_NAMES.rabbit,
            target: HEALTHCHECK_SERVICES_NAMES.api,
            label: 'Status check',
            color: 'gray',
          },
        },
        {
          classes: ['service-edge__horizontal-multiline'],
          data: {
            source: HEALTHCHECK_SERVICES_NAMES.redis,
            target: HEALTHCHECK_SERVICES_NAMES.api,
            label: 'FIFO data\nRedis check',
            color: 'gray',
          },
        },
        {
          data: {
            source: HEALTHCHECK_SERVICES_NAMES.api,
            target: HEALTHCHECK_SERVICES_NAMES.healthcheck,
            color: 'gray',
          },
        },
        {
          data: {
            source: HEALTHCHECK_SERVICES_NAMES.rabbit,
            target: HEALTHCHECK_ENGINES_NAMES.fifo,
            color: 'black',
          },
        },
        {
          data: {
            source: HEALTHCHECK_ENGINES_NAMES.fifo,
            target: HEALTHCHECK_SERVICES_NAMES.redis,
            label: 'RabbitMQ status',
            color: 'gray',
          },
        },
      ];
    },

    servicesElements() {
      return [
        ...this.servicesNodes.map(node => ({ group: 'node', ...node })),
        ...this.servicesEdges.map(edge => ({ group: 'edge', ...edge })),
      ];
    },

    enginesNodes() {
      return this.engines.nodes.map(node => ({
        classes: ['engine'],
        data: { ...node, id: node.name, color: '#2fab63' },
      }));
    },

    enginesEdges() {
      return this.engines.edges || [];
    },

    enginesElements() {
      return [];
    },

    nodeHtmlLabels() {
      return [
        {
          query: 'node',
          valign: 'top',
          halign: 'right',
          valignBox: 'top',
          halignBox: 'right',
          tpl: data => `<div>${data.id}</div>`,
        },
        {
          query: '.engine',
          valign: 'center',
          halign: 'right',
          valignBox: 'center',
          halignBox: 'right',
          tpl: data =>
            `<div class="ml-1"><div class="subheading">${data.id}</div><div class="body-1 grey--text darken-3">Queue length 312/500</div><div class="body-1 grey--text darken-3">Instances 5/3</div><div></div></div>`,
        },
        {
          query: '.without-node',
          valign: 'center',
          halign: 'center',
          tpl: data => `<div class="headline">${data.id}</div>`,
        },
        {
          query: '.without-node__error',
          valign: 'center',
          halign: 'center',
          tpl: data => `<div class="v-chip theme--light red white--text cursor-pointer"><span class="v-chip__content cursor-pointer headline">${data.id}</span></div>`,
        },
        {
          query: '.service-title-bottom',
          valign: 'bottom',
          halign: 'center',
          valignBox: 'bottom',
          halignBox: 'center',
          tpl: data => `<div class="subheading">${data.id}</div>`,
        },
      ];
    },

    cytoscapeStyleOption() {
      return [
        {
          selector: 'core',
          style: {
            'active-bg-size': 0,
          },
        },
        {
          selector: 'node',
          style: {
            width: 60,
            height: 60,
            'border-width': 3,
          },
        },
        {
          selector: `node[id="${HEALTHCHECK_SERVICES_NAMES.enginesChain}"]`,
          style: {
            events: 'no',
          },
        },
        {
          selector: 'node[color]',
          style: {
            'background-color': 'data(color)',
            'border-color': 'data(color)',
          },
        },
        {
          selector: '.without-node',
          style: {
            'background-opacity': 0,
            'border-width': 0,
          },
        },
        {
          selector: 'edge[label]',
          style: {
            label: 'data(label)',
            color: 'gray',
            'font-size': '14px',
            'text-wrap': 'wrap',
            'text-margin-y': -10,
          },
        },
        {
          selector: 'edge',
          style: {
            width: 2,
            'curve-style': 'bezier',
            'target-arrow-shape': 'triangle',
            'target-arrow-color': 'data(color)',
            'line-color': 'data(color)',
          },
        },
        {
          selector: '.service-edge__vertical',
          style: {
            'text-rotation': '90deg',
            'text-margin-x': 10,
            'text-margin-y': 0,
          },
        },
        {
          selector: '.service-edge__horizontal-multiline',
          style: {
            'text-margin-y': 0,
            'line-height': 1.5,
          },
        },
      ];
    },

    cytoscapeOptions() {
      return {
        container: this.$refs.canvasWrapper,
        elements: this.enginesElements,
        style: this.cytoscapeStyleOption,
        wheelSensitivity: 0.5,
        layout: {
          name: 'dagre',
          direction: true,
          spacingFactor: SPACING_FACTOR,
        },
        ready: this.addServicesElements,
      };
    },
  },
  mounted() {
    this.mountCytoscape();
  },
  beforeDestroy() {
    this.destroyCytoscape();
  },
  methods: {
    getNodeColor(node) {
      return {
        [HEALTHCHECK_STATUSES.ok]: CAT_ENGINES[node.name] ? COLORS.secondary : COLORS.primary,
        [HEALTHCHECK_STATUSES.notRunning]: COLORS.primary,
        [HEALTHCHECK_STATUSES.unknown]: COLORS.primary,
        [HEALTHCHECK_STATUSES.queueOverflow]: COLORS.primary,
        [HEALTHCHECK_STATUSES.tooFewInstances]: COLORS.primary,
        [HEALTHCHECK_STATUSES.diffInstancesConfig]: COLORS.primary,
      }[node.status] || COLORS.primary;
    },

    /**
     * Mount cytoscape
     */
    mountCytoscape() {
      this.$cy = cytoscape(this.cytoscapeOptions);

      this.$cy.bind('mouseover', 'node', this.nodeMouseoverHandler);
      this.$cy.bind('mouseout', 'node', this.nodeMouseoutHandler);
      this.$cy.bind('tap', 'node', this.nodeTapHandler);
    },

    /**
     * Destroy cytoscape
     */
    destroyCytoscape() {
      this.$cy.destroy();
    },

    /**
     * Add services elements into cytoscape
     */
    addServicesElements() {
      const [fifoNode] = this.$cy.nodes(`[id="${HEALTHCHECK_ENGINES_NAMES.fifo}"]`);
      const positionWithMinY = fifoNode
        ? fifoNode.renderedPosition()
        : minBy(this.$cy.nodes().renderedPosition(), 'y');


      if (!positionWithMinY) {
        return;
      }

      const preparedElements = this.servicesElements.map((element) => {
        if (element.group !== 'node') {
          return element;
        }
        const itemDiff = HEALTHCHECK_SERVICES_RENDERED_POSITIONS_DIFF[element.data.id];

        if (!itemDiff) {
          return element;
        }

        return {
          ...element,

          renderedPosition: {
            x: itemDiff.x + positionWithMinY.x,
            y: itemDiff.y + positionWithMinY.y,
          },
        };
      });

      this.$cy.add(preparedElements);
      this.$cy(this.$cy.nodes(), FIT_PADDING);
    },

    /**
     * Handler for the 'tap' event on node for cytoscape
     *
     * @param {Object} event
     */
    nodeTapHandler(event) {
      this.$emit('click', event);
    },

    /**
     * Handler for the 'mouseover' event on node for cytoscape
     *
     * @param {Object} target
     */
    nodeMouseoverHandler({ target }) {
      target.style('border-color', 'gray');

      this.$refs.cover.classList.add('canvas-wrapper--pointer');
    },

    /**
     * Handler for the 'mouseout' event on node for cytoscape
     *
     * @param {Object} target
     */
    nodeMouseoutHandler({ target }) {
      target.style('border-color', target.data('color'));

      this.$refs.cover.classList.remove('canvas-wrapper--pointer');
    },
  },
};
</script>

<style lang="scss" scoped>
.canvas-wrapper {
  position: relative;
  width: 100%;
  height: 100vh;
  cursor: grabbing;

  &--pointer {
    cursor: pointer;
  }
}
</style>
