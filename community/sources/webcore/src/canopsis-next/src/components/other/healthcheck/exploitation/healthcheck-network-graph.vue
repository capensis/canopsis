<template lang="pug">
  div.canvas-wrapper(ref="canvasWrapper")
</template>

<script>
import cytoscape from 'cytoscape';
import cytoscapeNodeHtmlLabel from 'cytoscape-node-html-label';
import cytoscapeDagre from 'cytoscape-dagre';

const SPACING_FACTOR = 1.9;
const NODES_SPACE = 85;
const SERVICES_NAMES = {
  mongo: 'MongoDB',
  redis: 'Redis',
  rabbit: 'RabbitMQ',
  events: 'Events',
  api: 'API',
  healthcheck: 'Healthcheck',
  enginesChain: 'Engines chain',
};

const ENGINES_NAMES = {
  fifo: 'engine-fifo',
};

const getDiff = (factor = 0) => NODES_SPACE * SPACING_FACTOR * factor;

const SERVICES_RENDERED_POSITIONS_DIFF = {
  [SERVICES_NAMES.events]: { x: getDiff(-3), y: getDiff(1) },
  [SERVICES_NAMES.mongo]: { x: getDiff(-3), y: 0 },
  [SERVICES_NAMES.api]: { x: getDiff(-2), y: 0 },
  [SERVICES_NAMES.rabbit]: { x: getDiff(-2), y: getDiff(1) },
  [SERVICES_NAMES.healthcheck]: { x: getDiff(-2), y: getDiff(-0.5) },
  [SERVICES_NAMES.redis]: { x: getDiff(-1), y: 0 },
  [SERVICES_NAMES.enginesChain]: { x: 0, y: getDiff(-0.5) },
};

cytoscapeNodeHtmlLabel(cytoscape);
cytoscape.use(cytoscapeDagre);

export default {
  props: {
    services: {
      type: Array,
      default: () => [],
    },
    engines: {
      type: Object,
      default: () => ({}),
    },
  },
  computed: {
    servicesNodes() {
      return [];
    },

    servicesEdges() {
      return [];
    },

    servicesElements() {
      return [];
    },

    enginesNodes() {
      return this.engines.nodes || [];
    },

    enginesEdges() {
      return this.engines.nodes || [];
    },

    enginesElements() {
      return [];
    },
  },
  mounted() {
    this.mountCytoscape();
  },
  beforeDestroy() {
    this.destroyCytoscape();
  },
  methods: {
    mountCytoscape() {
      this.$cy = cytoscape({
        container: this.$refs.canvasWrapper,
        ready: this.readyHandler,
      });

      this.$cy.bind('mouseover', 'node', this.nodeMouseoverHandler);
      this.$cy.bind('mouseout', 'node', this.nodeMouseoutHandler);
      this.$cy.bind('tap', 'node', this.nodeTapHandler);
    },

    destroyCytoscape() {
      this.$cy.destroy();
    },

    readyHandler() {
      this.addServicesElements();
    },

    addServicesElements() {
      const [fifoNode] = this.$cy.nodes(`[id="${ENGINES_NAMES.fifo}"]`);

      if (!fifoNode) {
        return;
      }

      const fifoEngineRenderedPosition = fifoNode.renderedPosition();
      const preparedElements = this.servicesElements.map((element) => {
        if (element.group !== 'node') {
          return element;
        }

        return {
          ...element,

          renderedPosition: {
            x: SERVICES_RENDERED_POSITIONS_DIFF[element.data.id].x + fifoEngineRenderedPosition.x,
            y: SERVICES_RENDERED_POSITIONS_DIFF[element.data.id].y + fifoEngineRenderedPosition.y,
          },
        };
      });

      this.$cy.add(preparedElements);
      this.$cy(this.$cy.nodes(), 15); // TODO: magic variable
    },

    addEnginesElements() {
      this.$cy.add(this.enginesElements);
    },

    nodeTapHandler(event) {
      this.$emit('click', event);
    },

    nodeMouseoverHandler({ target }) {
      target.style('border-color', 'gray');

      this.$refs.cover.classList.add('canvas-wrapper--pointer');
    },

    nodeMouseoutHandler({ target }) {
      target.style('border-color', target.data('color'));

      this.$refs.cover.classList.remove('canvas-wrapper--pointer');
    },
  },
};
</script>

<style lang="scss" scoped>
.canvas-wrapper {
  position: relative;
  width: 100%;
  height: 100vh;
  cursor: grabbing;

  &--pointer {
    cursor: pointer;
  }
}
</style>
