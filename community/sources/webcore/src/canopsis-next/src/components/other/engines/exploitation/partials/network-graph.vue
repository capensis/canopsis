<template lang="pug">
  v-fade-transition
    c-progress-overlay(v-if="loading", :pending="true")
    svg(v-else, :viewBox="`0 0 1000 ${simulatedHeight}`", :width="width")
      marker(
        :id="`arrowTriangle`",
        refX="11",
        refY="6",
        markerWidth="30",
        markerHeight="30",
        markerUnits="userSpaceOnUse",
        orient="auto"
      )
        path(d="M 0 0 12 6 0 12 3 6", fill="black")
      line(
        v-for="link in simulatedLinks",
        :key="link.id",
        :x1="link.x1",
        :y1="link.y1",
        :x2="link.x2",
        :y2="link.y2",
        stroke="black",
        marker-end="url(#arrowTriangle)"
      )
      g(
        v-for="node in simulatedNodes",
        :key="node.name"
      )
        circle.circle(
          :cx="node.x",
          :cy="node.y",
          :r="nodeRadius",
          :fill="node.color",
          @mouseover="$emit('node-over', node, $event)",
          @mouseout="$emit('node-out')"
        )
        text(
          :x="node.x + nodeRadius + nodeLabelFontSize",
          :y="node.y + (nodeRadius / 2)",
          :font-size="nodeLabelFontSize",
          :style="{ transform: `translateY(-${nodeLabelFontSize / 2}px)` }"
        )
          slot(name="node", :node="node")
</template>

<script>
import { simulateNetworkGraph } from '@/helpers/charts/d3-force';

export default {
  props: {
    nodes: {
      type: Array,
      default: () => [],
    },
    nodeRadius: {
      type: Number,
      default: 20,
    },
    width: {
      type: Number,
      default: 1000,
    },
    nodeLabelFontSize: {
      type: Number,
      default: 10,
    },
    linkDistance: {
      type: Number,
      default: 100,
    },
    loading: {
      type: Boolean,
      default: false,
    },
  },
  data() {
    return {
      simulatedNodes: [],
      simulatedLinks: [],
      simulatedHeight: 0,
    };
  },
  computed: {
    links() {
      return this.nodes.reduce((acc, node) => {
        if (node.dependencies) {
          acc.push(...node.dependencies.map(source => ({ source, target: node.name })));
        }

        return acc;
      }, []);
    },
  },
  watch: {
    nodes: 'generateGraph',
  },
  mounted() {
    this.generateGraph();
  },
  methods: {
    generateGraph() {
      const { links, nodes, height } = simulateNetworkGraph({
        nodes: this.nodes,
        links: this.links,
        width: this.width,
        nodeRadius: this.nodeRadius,
        linkDistance: this.linkDistance,
      });

      this.simulatedHeight = height;
      this.simulatedLinks = links;
      this.simulatedNodes = nodes;
    },
  },
};
</script>

<style lang="scss" scoped>
  .circle:hover {
    stroke: rgba(0, 0, 0, .3);
    stroke-width: 2;
  }
</style>
