<template lang="pug">
  v-card
    v-layout(row)
      v-flex(xs4)
        c-search-field(v-model="pagination.search", @submit="submitSearch", @clear="clearSearch")
    v-card-text
      c-advanced-data-table(
        :headers="headers",
        :items="entities",
        :loading="pending",
        :pagination.sync="pagination",
        :total-items="meta.total_count",
        item-key="_id"
      )
</template>

<script>
import { localQueryMixin } from '@/mixins/query-local/query';
import entitiesPbehaviorEntitiesMixin from '@/mixins/entities/pbehavior/entities';

export default {
  mixins: [localQueryMixin, entitiesPbehaviorEntitiesMixin],
  props: {
    pbehavior: {
      type: Object,
      default: () => ({}),
    },
  },
  data() {
    return {
      pending: false,
      meta: {},
      entities: [],
    };
  },
  computed: {
    headers() {
      return [
        {
          text: this.$t('common.id'),
          sortable: false,
          value: '_id',
        },
        {
          text: this.$t('common.name'),
          sortable: false,
          value: 'name',
        },
        {
          text: this.$t('common.type'),
          sortable: false,
          value: 'type',
        },
      ];
    },
  },
  mounted() {
    this.fetchList();
  },
  methods: {
    async fetchList() {
      this.pending = true;

      const { data: entities, meta } = await this.fetchPbehaviorEntitiesListWithoutStore({
        id: this.pbehavior._id,
        params: this.getQuery(),
      });

      this.meta = meta;
      this.entities = entities;

      this.pending = false;
    },

    submitSearch(search = '') {
      this.query = {
        ...this.query,
        search,
      };
    },

    clearSearch() {
      this.submitSearch();
    },
  },
};
</script>
