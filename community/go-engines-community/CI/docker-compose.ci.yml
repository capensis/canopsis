version: '2.4'
volumes:
  mongodbdata:
    driver: local
  influxdbdata:
      driver: local
  rabbitmqdata:
    driver: local
  dumpdata:
    driver: local
  exchangedata:
services:
  rabbitmq:
    image: rabbitmq:${RABBITMQ_TAG}
    volumes:
      - rabbitmqdata:/var/lib/rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=cpsrabbit
      - RABBITMQ_DEFAULT_PASS=canopsis
      - RABBITMQ_DEFAULT_VHOST=canopsis
    restart: unless-stopped
    mem_limit: 2g
    mem_reservation: 2g
    oom_score_adj: -1000
  mongodb:
    image: mongo:${MONGO_TAG}
    env_file: compose.mongo.env
    volumes:
      - mongodbdata:/data/db
      - "../docker/mongo/:/docker-entrypoint-initdb.d"
    restart: unless-stopped
    mem_limit: 3g
    mem_reservation: 3g
    oom_score_adj: -1000
    command: '--wiredTigerCacheSizeGB 2560'
  influxdb:
    image: influxdb:${INFLUX_TAG}
    platform: linux/x86_64
    environment:
      - INFLUXDB_DB=canopsis
      - INFLUXDB_ADMIN_USER=admin
      - INFLUXDB_ADMIN_PASSWORD=admin
      - INFLUXDB_USER=cpsinflux
      - INFLUXDB_PASSWORD=canopsis
      - INFLUXDB_WRITE_USER=cpsinflux
      - INFLUXDB_WRITE_USER_PASSWORD=canopsis
    volumes:
      - influxdbdata:/var/lib/influxdb
    restart: unless-stopped
    mem_limit: 1g
    mem_reservation: 1g
    oom_score_adj: -1000
  redis:
    image: redis:${REDIS_TAG} 
    restart: unless-stopped
  webserver:
    image: canopsis/canopsis-cat:latest
    env_file:
      - compose.env
    environment:
      - CPS_OLD_API=1
      - CPS_MONGO_URL=mongodb://cpsmongo:canopsis@mongodb/canopsis
    depends_on:
      - "mongodb"
    volumes:
      - dumpdata:/opt/canopsis/var/www/src/canopsis/dumpdata
    links:
      - mongodb
      - rabbitmq
      - influxdb
    restart: unless-stopped
#  init:
#    image: canopsis/init:latest
#    depends_on:
#      - "rabbitmq"
#      - "mongodb"
#    env_file:
#      - compose.env
#    volumes:
#      - "./docker/initialisation.toml:/initialisation.toml"
  testing:
    image: ${DOCKER_REPOSITORY}${PRO_BASE_PATH}canopsis/canopsis-go-test:latest
    env_file:
      - compose.env
    depends_on:
#      - init
      - mongodb
      - influxdb
      - redis
      - rabbitmq
      - webserver
    entrypoint: ["tail", "-F", "/dev/null"]
