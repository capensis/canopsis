<template lang="pug">
  div
    h2.text-xs-center.my-3.display-1.font-weight-medium {{ $t('dynamicInfo.title') }}
    div.white
      v-layout(row, wrap)
        v-flex(xs4)
          search-field(v-model="searchingText", @submit="submit", @clear="clear")
        v-flex(v-show="selected.length", xs4)
          v-btn(
            icon,
            v-if="hasDeleteAnyDynamicInformationAccess",
            @click="showDeleteSelectedDynamicInfosModal(selected)"
          )
            v-icon(color="error") delete
      v-data-table(
        v-model="selected",
        :pagination.sync="pagination",
        :items="dynamicInfos",
        :loading="dynamicInfosPending",
        :headers="headers",
        :total-items="dynamicInfosMeta.total",
        item-key="_id",
        hide-actions,
        select-all,
        expand
      )
        template(slot="progress")
          v-fade-transition
            v-progress-linear(height="2", indeterminate, color="primary")
        template(slot="items", slot-scope="props")
          tr(@click="props.expanded = !props.expanded")
            td(@click.stop="")
              v-checkbox-functional(v-model="props.selected", primary, hide-details)
            td {{ props.item._id }}
            td {{ props.item.name }}
            td {{ props.item.description }}
            td {{ props.item.author }}
            td {{ props.item.creation_date | date('long') }}
            td {{ props.item.last_modified_date | date('long') }}
            td
              v-layout(justify-start)
                v-btn(
                  icon,
                  small,
                  v-if="hasUpdateAnyDynamicInformationAccess",
                  @click.stop="showEditDynamicInfoModal(props.item)"
                )
                  v-icon edit
                v-btn(
                  icon,
                  small,
                  v-if="hasCreateAnyDynamicInformationAccess",
                  @click.stop="showDuplicateDynamicInfoModal(props.item)"
                )
                  v-icon file_copy
                v-btn.error--text(
                  icon,
                  small,
                  v-if="hasDeleteAnyDynamicInformationAccess",
                  @click.stop="showDeleteDynamicInfoModal(props.item._id)"
                )
                  v-icon(color="error") delete
        template(slot="expand", slot-scope="props")
          dynamic-infos-list-expand-item(:info="props.item")
      v-layout.white(align-center)
        v-flex(xs10)
          pagination(
            :page="query.page",
            :limit="query.limit",
            :total="dynamicInfosMeta.total",
            @input="updatePage"
          )
        v-spacer
        v-flex(xs2)
          records-per-page(:value="query.limit", @input="updateRowsPerPage")
</template>

<script>
import { omit } from 'lodash';

import { SORT_ORDERS } from '@/constants';

import widgetPaginationMixin from '@/mixins/widget/pagination';
import entitiesDynamicInfoMixin from '@/mixins/entities/dynamic-info';
import rightsTechnicalExploitationDynamicInformationMixin from '@/mixins/rights/technical/exploitation/dynamic-information';

import SearchField from '@/components/forms/fields/search-field.vue';

import DynamicInfosListExpandItem from './dynamic-infos-expand-item.vue';

export default {
  components: { SearchField, DynamicInfosListExpandItem },
  mixins: [
    widgetPaginationMixin,
    entitiesDynamicInfoMixin,
    rightsTechnicalExploitationDynamicInformationMixin,
  ],
  props: {
    query: {
      type: Object,
      required: true,
    },
    showEditDynamicInfoModal: {
      type: Function,
      default: () => () => {},
    },
    showDuplicateDynamicInfoModal: {
      type: Function,
      default: () => () => {},
    },
    showDeleteDynamicInfoModal: {
      type: Function,
      default: () => () => {},
    },
    showDeleteSelectedDynamicInfosModal: {
      type: Function,
      default: () => () => {},
    },
  },
  data() {
    return {
      searchingText: '',
      selected: [],
    };
  },
  computed: {
    headers() {
      return [
        { text: this.$t('dynamicInfo.table.id'), value: '_id' },
        { text: this.$t('dynamicInfo.table.name'), value: 'name', sortable: false },
        { text: this.$t('dynamicInfo.table.description'), value: 'description', sortable: false },
        { text: this.$t('dynamicInfo.table.user'), value: 'author' },
        { text: this.$t('dynamicInfo.table.creationDate'), value: 'creation_date', sortable: false },
        { text: this.$t('dynamicInfo.table.lastUpdateDate'), value: 'last_modified_date' },
        { text: this.$t('common.actionsLabel'), value: 'actions' },
      ];
    },

    pagination: {
      get() {
        const descending = this.query.sortDir !== null ? this.query.sortDir === SORT_ORDERS.desc : null;

        return { sortBy: this.query.sortKey, descending };
      },
      set(value) {
        const isNotEqualSortBy = value.sortBy !== this.pagination.sortBy;
        const isNotEqualDescending = value.descending !== this.pagination.descending;

        if (isNotEqualSortBy || isNotEqualDescending) {
          this.$emit('update:query', {
            ...this.query,

            sortKey: value.sortBy,
            sortDir: value.descending ? SORT_ORDERS.desc : SORT_ORDERS.asc,
          });
        }
      },
    },
  },
  watch: {
    query() {
      this.selected = [];
    },
  },
  methods: {
    updatePage(page) {
      this.$emit('update:query', { ...this.query, page });
    },

    updateRowsPerPage(rows) {
      this.$emit('update:query', { ...this.query, limit: rows });
    },

    submit() {
      this.$emit('update:query', {
        ...this.query,

        page: 1,
        search: this.searchingText,
      });
    },

    clear() {
      this.searchingText = '';

      this.$emit('update:query', omit(this.query, ['search']));
    },
  },
};
</script>
