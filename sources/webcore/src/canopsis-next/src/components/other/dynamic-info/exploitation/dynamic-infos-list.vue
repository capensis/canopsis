<template lang="pug">
  div
    h2.text-xs-center.my-3.display-1.font-weight-medium {{ $t('dynamicInfo.title') }}
    div.white
      v-layout(row, wrap)
        v-flex(xs4)
          search-field(v-model="searchingText", @submit="submit", @clear="clear")
        v-flex(v-show="selected.length", xs4)
          v-btn(icon, @click="showDeleteSelectedDynamicInfosModal(selected)")
            v-icon(color="error") delete
    v-data-table(
      v-model="selected",
      :items="dynamicInfos",
      :loading="pending",
      :headers="headers",
      item-key="_id",
      hide-actions,
      select-all,
      expand
    )
      template(slot="progress")
        v-fade-transition
          v-progress-linear(height="2", indeterminate, color="primary")
      template(slot="items", slot-scope="props")
        tr(@click="props.expanded = !props.expanded")
          td(@click.stop="")
            v-checkbox-functional(v-model="props.selected", primary, hide-details)
          td {{ props.item._id }}
          td {{ props.item.name }}
          td {{ props.item.description }}
          td {{ props.item.user }}
          td {{ props.item.creation_date }}
          td {{ props.item.last_update_date }}
          td
            v-layout
              v-flex
                v-btn(
                  icon,
                  small,
                  @click.stop=""
                )
                  v-icon edit
                v-btn.error--text(
                  icon,
                  small,
                  @click.stop="showDeleteDynamicInfoModal(props.item._id)"
                )
                  v-icon(color="error") delete
</template>

<script>
import { omit } from 'lodash';

import widgetPaginationMixin from '@/mixins/widget/pagination';

import SearchField from '@/components/forms/fields/search-field.vue';

export default {
  components: { SearchField },
  mixins: [widgetPaginationMixin],
  props: {
    dynamicInfos: {
      type: Array,
      default: () => [],
    },
    pending: {
      type: Boolean,
      default: false,
    },
    showDeleteDynamicInfoModal: {
      type: Function,
      default: () => () => {},
    },
    showDeleteSelectedDynamicInfosModal: {
      type: Function,
      default: () => () => {},
    },
  },
  data() {
    return {
      searchingText: '',
      selected: [],
    };
  },
  computed: {
    headers() {
      return [
        { text: this.$t('dynamicInfo.table.id'), value: 'id' },
        { text: this.$t('dynamicInfo.table.name'), value: 'name' },
        { text: this.$t('dynamicInfo.table.description'), value: 'description' },
        { text: this.$t('dynamicInfo.table.user'), value: 'user' },
        { text: this.$t('dynamicInfo.table.creationDate'), value: 'creation_date' },
        { text: this.$t('dynamicInfo.table.lastUpdateDate'), value: 'last_update_date' },
        { text: this.$t('common.actionsLabel'), value: 'actions' },
      ];
    },
  },
  watch: {
    query() {
      this.selected = [];
    },
  },
  methods: {
    updatePage(page) {
      this.$emit('update:query', { ...this.query, page });
    },

    updateRowsPerPage(rows) {
      this.$emit('update:query', { ...this.query, limit: rows });
    },

    submit() {
      this.$emit('update:query', {
        ...this.query,

        page: 1,
        search: this.searchingText,
      });
    },

    clear() {
      this.searchingText = '';

      this.$emit('update:query', omit(this.query, ['search']));
    },
  },
};
</script>
