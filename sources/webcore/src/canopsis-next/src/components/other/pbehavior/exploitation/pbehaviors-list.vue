<template lang="pug">
  div
    h2.text-xs-center.my-3.display-1.font-weight-medium {{ $t('common.pbehaviors') }}
    div.white
      v-layout(row, wrap)
        v-flex(xs4)
          search-field(v-model="searchingText", @submit="submitSearch", @clear="clearSearch")
        v-flex(v-show="selected.length", xs4)
          v-btn(icon, @click="showDeleteSelectedPbehaviorsModal(selected)")
            v-icon(color="error") delete
      v-data-table(
        v-model="selected",
        :items="pbehaviors",
        :pagination.sync="pagination",
        :loading="pbehaviorsPending",
        :headers="headers",
        :total-items="pbehaviorsMeta.total",
        item-key="_id",
        hide-actions,
        select-all,
        expand
      )
        template(slot="progress")
          v-fade-transition
            v-progress-linear(height="2", indeterminate, color="primary")
        template(slot="items", slot-scope="props")
          tr(@click="props.expanded = !props.expanded")
            td(@click.stop="")
              v-checkbox(v-model="props.selected", primary, hide-details)
            td
              ellipsis(:text="props.item.name")
            td {{ props.item.author }}
            td {{ props.item.connector }}
            td {{ props.item.connector_name }}
            td
              enabled-column(:value="props.item.enabled")
            td {{ props.item.tstart | date('long', true) }}
            td {{ props.item.tstop | date('long', true) }}
            td {{ props.item.type_ }}
            td {{ props.item.reason }}
            td
              v-icon {{ props.item.rrule ? 'check' : 'clear' }}
            td
              v-icon(
                :color="props.item.is_currently_active ? 'primary' : 'error'",
                slot="activator"
              ) $vuetify.icons.settings_sync
            td
              v-layout(justify-start)
                v-btn(
                  v-if="hasUpdateAnyPbehaviorAccess",
                  icon,
                  small,
                  @click.stop="showEditPbehaviorModal(props.item)"
                )
                  v-icon edit
                v-btn(
                  v-if="hasCreateAnyPbehaviorAccess",
                  icon,
                  small,
                  @click.stop="showDuplicatePbehaviorModal(props.item)"
                )
                  v-icon file_copy
                v-btn.error--text(
                  v-if="hasDeleteAnyPbehaviorAccess",
                  icon,
                  small,
                  @click.stop="showDeletePbehaviorModal(props.item._id)"
                )
                  v-icon(color="error") delete
        template(slot="expand", slot-scope="props")
          pbehaviors-list-expand-item(:pbehavior="props.item")
    v-layout.white(align-center)
      v-flex(xs10)
        pagination(
          :page="query.page",
          :limit="query.limit",
          :total="pbehaviorsMeta.total",
          @input="updateQueryPage"
        )
      v-spacer
      v-flex(xs2)
        records-per-page(:value="query.limit", @input="updateQueryLimit")
</template>

<script>
import queryPaginationMixin from '@/mixins/query/pagination';
import querySearchingMixin from '@/mixins/query/searching';
import entitiesPbehaviorMixin from '@/mixins/entities/pbehavior';
import rightsTechnicalExploitationPbehaviorMixin from '@/mixins/rights/technical/exploitation/pbehavior';
import vuetifyPaginationMixinCreator from '@/mixins/vuetify/pagination-creator';

import Ellipsis from '@/components/tables/ellipsis.vue';
import SearchField from '@/components/forms/fields/search-field.vue';
import RefreshBtn from '@/components/other/view/buttons/refresh-btn.vue';
import Pagination from '@/components/tables/pagination.vue';
import RecordsPerPage from '@/components/tables/records-per-page.vue';
import EnabledColumn from '@/components/tables/enabled-column.vue';

import PbehaviorsListExpandItem from './pbehaviors-list-expand-item.vue';

export default {
  components: {
    Ellipsis,
    SearchField,
    RefreshBtn,
    Pagination,
    RecordsPerPage,
    EnabledColumn,
    PbehaviorsListExpandItem,
  },
  mixins: [
    queryPaginationMixin,
    querySearchingMixin,
    entitiesPbehaviorMixin,
    rightsTechnicalExploitationPbehaviorMixin,
    vuetifyPaginationMixinCreator(),
  ],
  props: {
    query: {
      type: Object,
      required: true,
    },
    showEditPbehaviorModal: {
      type: Function,
      default: () => () => {},
    },
    showDuplicatePbehaviorModal: {
      type: Function,
      default: () => () => {},
    },
    showDeletePbehaviorModal: {
      type: Function,
      default: () => () => {},
    },
    showDeleteSelectedPbehaviorsModal: {
      type: Function,
      default: () => () => {},
    },
  },
  data() {
    return {
      selected: [],
    };
  },
  computed: {
    headers() {
      return [
        { text: this.$t('common.name'), value: 'name' },
        { text: this.$t('common.author'), value: 'author' },
        { text: this.$t('pbehaviors.connector'), value: 'connector' },
        { text: this.$t('pbehaviors.connectorName'), value: 'connector_name' },
        { text: this.$t('pbehaviors.isEnabled'), value: 'enabled' },
        { text: this.$t('pbehaviors.begins'), value: 'tstart' },
        { text: this.$t('pbehaviors.ends'), value: 'tstop' },
        { text: this.$t('pbehaviors.type'), value: 'type' },
        { text: this.$t('pbehaviors.reason'), value: 'reason' },
        { text: this.$t('pbehaviors.rrule'), value: 'rrule' },
        { text: this.$t('pbehaviors.status'), value: 'is_currently_active' },
        { text: this.$t('common.actionsLabel'), value: 'actions', sortable: false },
      ];
    },
  },
  watch: {
    query() {
      this.selected = [];
    },
  },
};
</script>
