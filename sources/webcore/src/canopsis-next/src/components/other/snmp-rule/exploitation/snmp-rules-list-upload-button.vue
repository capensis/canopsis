<template lang="pug">
  file-selector(
    ref="fileSelector",
    multiple,
    hide-details,
    @change="changeFiles"
  )
    v-tooltip(slot="activator", slot-scope="{ on }")
      v-btn(
        slot="activator",
        color="indigo",
        small,
        dark,
        fab,
        @click="on.click"
      )
        v-icon cloud_upload
      span {{ $t('snmpRules.uploadMib') }}
</template>

<script>
import { createNamespacedHelpers } from 'vuex';

import { getFileTextContent } from '@/helpers/file-select';

import popupMixin from '@/mixins/popup';

import FileSelector from '@/components/forms/fields/file-selector.vue';

const { mapActions } = createNamespacedHelpers('snmpMib');

export default {
  components: { FileSelector },
  mixins: [popupMixin],
  methods: {
    ...mapActions({
      uploadSnmpMib: 'upload',
    }),

    async changeFiles(files = []) {
      try {
        if (files.length) {
          const promises = files.sort((a, b) => {
            const matchesA = a.name.match(/^(\d+)/) || ['0'];
            const matchesB = b.name.match(/^(\d+)/) || ['0'];

            return parseInt(matchesA[0], 10) - parseInt(matchesB[0], 10);
          }).map(file => getFileTextContent(file));

          const results = await Promise.all(promises);

          const { data: [{ msg, data }] } = await this.uploadSnmpMib({
            data: results.join(''),
          });

          const popup = {
            text: msg,
            autoClose: 10000,
          };

          if (data && data.length) {
            this.addErrorPopup(popup);
          } else {
            this.addSuccessPopup(popup);
          }
        }
      } catch (err) {
        this.addErrorPopup({
          text: this.$t('errors.default'),
        });
      }

      this.$refs.fileSelector.clear();
    },
  },
};
</script>
