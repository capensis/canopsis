<template lang="pug">
  file-select(
  ref="fileSelect",
  :tooltip="$t('snmpRules.uploadMib')",
  :btnProps="btnProps",
  multiple,
  @change="changeFile"
  )
</template>

<script>
import { createNamespacedHelpers } from 'vuex';

import { getFileTextContent } from '@/helpers/file-select';

import popupMixin from '@/mixins/popup';

import FileSelect from '@/components/forms/fields/file-select.vue';

const { mapActions } = createNamespacedHelpers('snmpMib');

export default {
  components: { FileSelect },
  mixins: [popupMixin],
  computed: {
    btnProps() {
      return {
        color: 'indigo',
        small: true,
        dark: true,
        fab: true,
      };
    },
  },
  methods: {
    ...mapActions({
      uploadSnmpMib: 'upload',
    }),

    async changeFile(e) {
      try {
        const { files } = e.target;

        const promises = Object.values(files).sort((a, b) => {
          const matchesA = a.name.match(/^(\d+)/) || ['0'];
          const matchesB = b.name.match(/^(\d+)/) || ['0'];

          return parseInt(matchesA[0], 10) - parseInt(matchesB[0], 10);
        }).map(file => getFileTextContent(file));

        const results = await Promise.all(promises);

        const { data: [{ msg, data }] } = await this.uploadSnmpMib({
          data: results.join(''),
        });

        const popup = {
          text: msg,
          autoClose: 10000,
        };

        if (data && data.length) {
          this.addErrorPopup(popup);
        } else {
          this.addSuccessPopup(popup);
        }
      } catch (err) {
        this.addErrorPopup({
          text: this.$t('errors.default'),
        });
      }

      this.$refs.fileSelect.clear();
    },
  },
};
</script>
