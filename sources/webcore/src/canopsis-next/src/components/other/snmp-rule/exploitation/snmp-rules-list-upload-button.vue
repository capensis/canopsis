<template lang="pug">
  v-tooltip(top)
    v-btn(
    slot="activator",
    color="indigo",
    small,
    dark,
    fab,
    @click.stop="selectFiles"
    )
      v-icon cloud_upload
    input.hidden(ref="fileInput", type="file", multiple, @change="changeFile")
    span {{ $t('snmpRules.uploadMib') }}
</template>

<script>
import { createNamespacedHelpers } from 'vuex';

import popupMixin from '@/mixins/popup';

const { mapActions } = createNamespacedHelpers('snmpMib');

export default {
  mixins: [popupMixin],
  props: {
    value: {
      type: File,
    },
  },
  data() {
    return {
      files: [],
    };
  },
  methods: {
    ...mapActions({
      uploadSnmpMib: 'upload',
    }),

    selectFiles() {
      this.$refs.fileInput.click();
    },

    async changeFile(e) {
      try {
        const { files } = e.target;

        const promises = Object.values(files).sort((a, b) => {
          const matchesA = a.name.match(/^(\d+)/) || ['0'];
          const matchesB = b.name.match(/^(\d+)/) || ['0'];

          return parseInt(matchesA[0], 10) - parseInt(matchesB[0], 10);
        }).map(file => this.getFileContent(file));

        const results = await Promise.all(promises);

        const { data: [{ msg, data }] } = await this.uploadSnmpMib({
          data: results.join(''),
        });

        const popup = {
          text: msg,
          autoClose: 10000,
        };

        if (data && data.length) {
          this.addErrorPopup(popup);
        } else {
          this.addSuccessPopup(popup);
        }
      } catch (err) {
        this.addErrorPopup({
          text: this.$t('errors.default'),
        });
      }

      this.$refs.fileInput.value = null;
    },

    getFileContent(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.readAsText(file, 'UTF-8');
        reader.addEventListener('load', e => resolve(e.target.result));
        reader.addEventListener('error', reject);
      });
    },
  },
};
</script>

<style scoped>
  .hidden {
    display: none;
  }
</style>
