<template lang="pug">
  div
    h2.text-xs-center.my-3.display-1.font-weight-medium {{ $t('eventFilter.title') }}
    .white
      v-layout(row, wrap)
        v-flex(v-show="hasDeleteAnyEventFilterAccess && selected.length", xs4)
          v-btn(icon, @click="showDeleteSelectedRulesModal(selected)")
            v-icon(color="error") delete
      v-data-table(
        v-model="selected",
        :items="rules",
        :headers="headers",
        :loading="pending",
        item-key="_id",
        select-all,
        expand
      )
        template(slot="items", slot-scope="props")
          tr(@click="props.expanded = !props.expanded")
            td(@click.stop="")
              v-checkbox-functional(v-model="props.selected", primary, hide-details)
            td {{ props.item._id }}
            td {{ props.item.type }}
            td {{ props.item.priority }}
            td
              enabled-column(:value="isRuleEnabled(props.item)")
            td
              v-layout
                v-btn(
                  v-if="hasUpdateAnyEventFilterAccess",
                  icon,
                  small,
                  @click.stop="showEditRuleModal(props.item)"
                )
                  v-icon edit
                v-btn(
                  v-if="hasCreateAnyEventFilterAccess",
                  icon,
                  small,
                  @click.stop="showDuplicateRuleModal(props.item)"
                )
                  v-icon file_copy
                v-btn(
                  v-if="hasDeleteAnyEventFilterAccess",
                  icon,
                  small,
                  @click.stop="showDeleteRuleModal(props.item._id)"
                )
                  v-icon.error--text delete
        template(slot="expand", slot-scope="props")
          v-tabs(color="secondary lighten-1", dark, centered)
            v-tab {{ $t('common.description') }}
            v-tab {{ $t('eventFilter.pattern') }}
            v-tab(
              :disabled="props.item.type !== $constants.EVENT_FILTER_RULE_TYPES.enrichment"
            ) {{ $t('eventFilter.externalDatas') }}
            v-tab(
              :disabled="props.item.type !== $constants.EVENT_FILTER_RULE_TYPES.enrichment"
            ) {{ $t('eventFilter.actions') }}
            v-tab-item
              v-layout.py-3.secondary.lighten-2(row)
                v-textarea.my-2.mx-4.pa-0(
                  :value="props.item.description",
                  readonly,
                  auto-grow,
                  outline,
                  hide-details,
                  dark
                )
            v-tab-item(lazy)
              v-layout.py-3.secondary.lighten-2(row)
                v-textarea.my-2.mx-4.pa-0(
                  :value="props.item.pattern | json",
                  readonly,
                  auto-grow,
                  outline,
                  hide-details,
                  dark
                )
            v-tab-item(lazy)
              v-layout.py-3.secondary.lighten-2(row)
                v-textarea.my-2.mx-4.pa-0(
                  :value="props.item.external_data | json",
                  readonly,
                  auto-grow,
                  outline,
                  hide-details,
                  dark
                )
            v-tab-item
              v-layout.py-3.secondary.lighten-2(row, justify-center)
                v-flex(xs11)
                  v-data-table(:items="props.item.actions", hide-headers)
                    template(slot="items", slot-scope="props")
                      td(v-for="(value, key) in props.item")
                        span.font-weight-bold.text-capitalize {{ key }} :
                        span  {{ value }}
</template>

<script>
import { has } from 'lodash';

import rightsTechnicalExploitationEventFilterMixin from '@/mixins/rights/technical/exploitation/event-filter';

import EnabledColumn from '@/components/tables/enabled-column.vue';

export default {
  components: { EnabledColumn },
  mixins: [
    rightsTechnicalExploitationEventFilterMixin,
  ],
  props: {
    rules: {
      type: Array,
      default: () => [],
    },
    pending: {
      type: Boolean,
      default: true,
    },
    showEditRuleModal: {
      type: Function,
      default: () => () => {},
    },
    showDuplicateRuleModal: {
      type: Function,
      default: () => () => {},
    },
    showDeleteRuleModal: {
      type: Function,
      default: () => () => {},
    },
    showDeleteSelectedRulesModal: {
      type: Function,
      default: () => () => {},
    },
  },
  data() {
    return {
      selected: [],
    };
  },
  computed: {
    headers() {
      return [
        {
          text: this.$t('eventFilter.id'),
          value: '_id',
        },
        {
          text: this.$t('eventFilter.type'),
          value: 'type',
        },
        {
          text: this.$t('eventFilter.priority'),
          value: 'priority',
        },
        {
          text: this.$t('eventFilter.enabled'),
          value: 'enabled',
        },
        {
          text: this.$t('eventFilter.actions'),
          sortable: false,
        },
      ];
    },
    isRuleEnabled() {
      return rule => !has(rule, 'enabled') || rule.enabled;
    },
  },
  watch: {
    rules() {
      this.selected = [];
    },
  },
};
</script>

