<template lang="pug">
  div
    h2.text-xs-center.my-3.display-1.font-weight-medium {{ $t('common.pbehaviors') }}
    div.white
      v-layout(row, wrap)
        v-flex(xs4)
          search-field(v-model="searchingText")
        v-flex(v-show="selected.length", xs4)
          v-btn(@click="showDeleteSelectedPbehaviorsModal", icon)
            v-icon(color="error") delete
      v-data-table(
      v-model="selected",
      :items="pbehaviors",
      :loading="pending",
      :headers="headers",
      :pagination.sync="vDataTablePagination",
      :search="searchingText",
      :custom-filter="tableFilter",
      item-key="_id",
      hide-actions,
      select-all,
      expand
      )
        template(slot="progress")
          v-fade-transition
            v-progress-linear(height="2", indeterminate, color="primary")
        template(slot="items", slot-scope="props")
          tr(@click="props.expanded = !props.expanded")
            td(@click.stop="")
              v-checkbox(v-model="props.selected", primary, hide-details)
            td
              ellipsis(:text="props.item.name")
            td {{ props.item.author }}
            td {{ props.item.connector }}
            td {{ props.item.connector_name }}
            td
              v-icon(v-if="props.item.enabled", color="primary") check_circle
              v-icon(v-else, color="error") cancel
            td {{ props.item.tstart | date('long', true) }}
            td {{ props.item.tstop | date('long', true) }}
            td {{ props.item.type_ }}
            td {{ props.item.reason }}
            td
              v-icon {{ props.item.rrule ? 'check' : 'clear' }}
            td
              v-layout
                v-flex
                  v-btn.error--text(icon, small, @click="showDeletePbehaviorModal(props.item._id)")
                    v-icon(color="error") delete
        template(slot="expand", slot-scope="props")
          pbehaviors-list-expand-item(:pbehavior="props.item")
    v-layout.white(align-center)
      v-flex(xs10)
        pagination(
        :page="query.page",
        :limit="query.limit",
        :total="query.totalItems",
        @input="updateQueryPage"
        )
      v-spacer
      v-flex(xs2)
        records-per-page(v-model="query.limit")
</template>

<script>
import { createNamespacedHelpers } from 'vuex';
import { pick } from 'lodash';

import { PAGINATION_LIMIT } from '@/config';
import { MODALS } from '@/constants';

import modalMixin from '@/mixins/modal';
import widgetPaginationMixin from '@/mixins/widget/pagination';

import Ellipsis from '@/components/tables/ellipsis.vue';
import SearchField from '@/components/forms/fields/search-field.vue';
import RefreshBtn from '@/components/other/view/refresh-btn.vue';
import RecordsPerPage from '@/components/tables/records-per-page.vue';

import PbehaviorsListExpandItem from './pbehaviors-list-expand-item.vue';

const { mapActions } = createNamespacedHelpers('pbehavior');

export default {
  components: {
    Ellipsis,
    SearchField,
    RefreshBtn,
    RecordsPerPage,
    PbehaviorsListExpandItem,
  },
  mixins: [
    modalMixin,
    widgetPaginationMixin,
  ],
  props: {
    pbehaviors: {
      type: Array,
      default: () => [],
    },
    meta: {
      type: Object,
      default: () => ({}),
    },
    pending: {
      type: Boolean,
      default: true,
    },
  },
  data() {
    return {
      searchingText: '',
      query: {
        limit: PAGINATION_LIMIT,
        page: 1,
        descending: false,
        sortBy: null,
      },
      selected: [],
    };
  },
  computed: {
    headers() {
      return [
        { text: this.$t('common.name'), value: 'name' },
        { text: this.$t('common.author'), value: 'author' },
        { text: this.$t('pbehaviors.connector'), value: 'connector' },
        { text: this.$t('pbehaviors.connectorName'), value: 'connector_name' },
        { text: this.$t('pbehaviors.isEnabled'), value: 'enabled' },
        { text: this.$t('pbehaviors.begins'), value: 'tstart' },
        { text: this.$t('pbehaviors.ends'), value: 'tstop' },
        { text: this.$t('pbehaviors.type'), value: 'type' },
        { text: this.$t('pbehaviors.reason'), value: 'reason' },
        { text: this.$t('pbehaviors.rrule'), value: 'rrule' },
        { text: this.$t('common.actionsLabel'), value: 'actions' },
      ];
    },

    vDataTablePagination: {
      get() {
        return {
          ...pick(this.query, ['page', 'descending', 'sortBy', 'totalItems']),

          rowsPerPage: this.query.limit,
        };
      },
      set(value) {
        this.query = {
          ...pick(value, ['page', 'descending', 'sortBy', 'totalItems']),

          limit: value.rowsPerPage,
        };
      },
    },
  },
  watch: {
    query() {
      this.selected = [];
    },

    meta(value) {
      this.$nextTick(() => this.query.totalItems = value.total);
    },
  },
  methods: {
    ...mapActions({
      removePbehavior: 'remove',
    }),

    tableFilter(items = [], search = '') {
      const searchInLowerCase = search.toLowerCase();

      if (searchInLowerCase.length === 0) {
        return items;
      }

      return items.filter(({
        name = '', reason = '', author = '', type_ = '', eids = [],
      } = {}) => (
        (name && name.toLowerCase().indexOf(searchInLowerCase) >= 0) ||
        (reason && reason.toLowerCase().indexOf(searchInLowerCase) >= 0) ||
        (author && author.toLowerCase().indexOf(searchInLowerCase) >= 0) ||
        (type_ && type_.toLowerCase().indexOf(searchInLowerCase) >= 0) ||
        (eids && eids.filter(eid => eid.toLowerCase().indexOf(searchInLowerCase) >= 0).length > 0)
      ));
    },

    showDeletePbehaviorModal(id) {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: () => this.removePbehavior({ id }),
        },
      });
    },

    showDeleteSelectedPbehaviorsModal() {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await Promise.all(this.selected.map(pbehavior => this.removePbehavior({ id: pbehavior._id })));

            this.selected = [];
          },
        },
      });
    },
  },
};
</script>
