<template lang="pug">
  div
    h2.text-xs-center.my-3.display-1.font-weight-medium {{ $t('webhook.title') }}
    .white
      v-layout(row, wrap)
        v-flex(v-show="hasDeleteAnyWebhookAccess && selected.length", xs4)
          v-btn(icon, @click="showDeleteSelectedWebhooksModal(selected)")
            v-icon(color="error") delete
      v-data-table(
        v-model="selected",
        :items="webhooks",
        :headers="headers",
        :loading="pending",
        item-key="_id",
        select-all,
        expand
      )
        template(slot="items", slot-scope="props")
          tr(@click="props.expanded = !props.expanded")
            td(@click.stop="")
              v-checkbox-functional(v-model="props.selected", primary, hide-details)
            td {{ props.item._id }}
            td {{ props.item.request.method }}
            td {{ props.item.request.url }}
            td {{ props.item.retry | get('count') }}
            td {{ props.item.retry | retryDelay }}
            td
              enabled-column(:value="props.item.enabled | enabled")
            td
              v-layout
                v-btn(
                  v-if="hasUpdateAnyWebhookAccess",
                  icon,
                  small,
                  @click.stop="showEditWebhookModal(props.item)"
                )
                  v-icon edit
                v-btn(
                  v-if="hasCreateAnyWebhookAccess",
                  icon,
                  small,
                  @click.stop="showDuplicateWebhookModal(props.item)"
                )
                  v-icon file_copy
                v-btn(
                  v-if="hasDeleteAnyWebhookAccess",
                  icon,
                  small,
                  @click.stop="showDeleteWebhookModal(props.item._id)"
                )
                  v-icon.error--text delete
        template(slot="expand", slot-scope="{ item }")
          webhook-form(:form="webhookToForm(item)", dark, disabled)
</template>

<script>
import rightsTechnicalExploitationWebhookMixin from '@/mixins/rights/technical/exploitation/webhook';

import { webhookToForm } from '@/helpers/forms/webhook';

import WebhookForm from '@/components/other/webhook/form/webhook-form.vue';
import EnabledColumn from '@/components/tables/enabled-column.vue';

export default {
  components: {
    WebhookForm,
    EnabledColumn,
  },
  filters: {
    retryDelay(retry) {
      return retry && retry.delay && `${retry.delay}${retry.unit}`;
    },
    enabled(enabled = true) {
      return enabled;
    },
  },
  mixins: [rightsTechnicalExploitationWebhookMixin],
  props: {
    webhooks: {
      type: Array,
      default: () => [],
    },
    pending: {
      type: Boolean,
      default: true,
    },
    showEditWebhookModal: {
      type: Function,
      default: () => () => {},
    },
    showDuplicateWebhookModal: {
      type: Function,
      default: () => () => {},
    },
    showDeleteWebhookModal: {
      type: Function,
      default: () => () => {},
    },
    showDeleteSelectedWebhooksModal: {
      type: Function,
      default: () => () => {},
    },
  },
  data() {
    return {
      selected: [],
    };
  },
  computed: {
    headers() {
      return [
        {
          text: this.$t('webhook.table.headers.id'),
          value: '_id',
        },
        {
          text: this.$t('webhook.table.headers.requestMethod'),
          value: 'request.method',
        },
        {
          text: this.$t('webhook.table.headers.requestUrl'),
          value: 'request.url',
        },
        {
          text: this.$t('webhook.table.headers.retryCount'),
          value: 'retry.count',
        },
        {
          text: this.$t('webhook.table.headers.retryDelay'),
          value: 'retry.delay',
        },
        {
          text: this.$t('webhook.table.headers.enabled'),
          value: 'enabled',
        },
        {
          text: this.$t('common.actionsLabel'),
          sortable: false,
        },
      ];
    },
  },
  watch: {
    webhooks() {
      this.selected = [];
    },
  },
  methods: {
    webhookToForm,
  },
};
</script>

