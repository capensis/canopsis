<template lang="pug">
  div
    actions-list(
      :showDeleteActionModal="showDeleteActionModal",
      :showEditActionModal="showEditActionModal",
      :showDeleteSelectedActionsModal="showDeleteSelectedActionsModal",
      :showDuplicateActionModal="showDuplicateActionModal"
    )
    .fab
      v-layout(column)
        refresh-btn(@click="refreshActionsList")
        v-tooltip(left, v-if="hasCreateAnyActionAccess")
          v-btn(
            slot="activator",
            color="primary",
            fab,
            dark,
            @click.stop="showCreateActionModal"
          )
            v-icon add
          span {{ $t('actions.addAction') }}
</template>

<script>
import { MODALS } from '@/constants';

import ActionsList from '@/components/other/action/exploitation/actions-list.vue';
import RefreshBtn from '@/components/other/view/buttons/refresh-btn.vue';

import rightsTechnicalExploitationActionMixin from '@/mixins/rights/technical/exploitation/action';
import entitiesActionMixin from '@/mixins/entities/action';

export default {
  components: {
    ActionsList,
    RefreshBtn,
  },
  mixins: [rightsTechnicalExploitationActionMixin, entitiesActionMixin],
  mounted() {
    this.fetchActionsList();
  },
  methods: {
    showCreateActionModal() {
      this.$modals.show({
        name: MODALS.createAction,
        config: {
          action: async (data) => {
            await this.createAction({ data });
            this.$popups.success({ text: this.$t('modals.createAction.create.success') });
            this.refreshActionsList();
          },
        },
      });
    },

    showEditActionModal(item) {
      this.$modals.show({
        name: MODALS.createAction,
        config: {
          item,
          action: async (data) => {
            await this.updateAction({ data, id: item._id });
            this.$popups.success({ text: this.$t('modals.createAction.edit.success') });
            this.refreshActionsList();
          },
        },
      });
    },

    showDuplicateActionModal(item) {
      this.$modals.show({
        name: MODALS.createAction,
        config: {
          item,
          isDuplicating: true,
          action: async (data) => {
            await this.createAction({ data, id: item._id });
            this.$popups.success({ text: this.$t('modals.createAction.duplicate.success') });
            this.refreshActionsList();
          },
        },
      });
    },

    showDeleteActionModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.removeAction({ id });
            this.$popups.success({ text: this.$t('modals.createAction.remove.success') });
            this.refreshActionsList();
          },
        },
      });
    },

    showDeleteSelectedActionsModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await Promise.all(selected.map(action => this.removeAction({ id: action._id })));

            this.refreshActionsList();
            this.selected = [];
          },
        },
      });
    },
  },
};
</script>

