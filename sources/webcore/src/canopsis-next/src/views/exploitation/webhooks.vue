<template lang="pug">
  v-container
    webhooks-list(
      :webhooks="webhooks",
      :pending="webhooksPending",
      :showEditWebhookModal="showEditWebhookModal",
      :showDuplicateWebhookModal="showDuplicateWebhookModal",
      :showDeleteWebhookModal="showDeleteWebhookModal",
      :showDeleteSelectedWebhooksModal="showDeleteSelectedWebhooksModal"
    )
    .fab
      v-layout(column)
        refresh-btn(@click="refreshWebhooksList")
        v-tooltip(v-if="hasCreateAnyWebhookAccess", left)
          v-btn(slot="activator", @click="showCreateWebhookModal", color="primary", dark, fab, icon)
            v-icon add
          span {{ $t('modals.createWebhook.create.title') }}
</template>

<script>
import { MODALS } from '@/constants';

import entitiesWebhookMixin from '@/mixins/entities/webhook';
import rightsTechnicalExploitationWebhookMixin from '@/mixins/rights/technical/exploitation/webhook';

import WebhooksList from '@/components/other/webhook/exploitation/webhooks-list.vue';
import RefreshBtn from '@/components/other/view/buttons/refresh-btn.vue';

export default {
  components: {
    WebhooksList,
    RefreshBtn,
  },
  mixins: [
    entitiesWebhookMixin,
    rightsTechnicalExploitationWebhookMixin,
  ],
  mounted() {
    this.fetchWebhooksList();
  },
  methods: {
    showCreateWebhookModal() {
      this.$modals.show({
        name: MODALS.createWebhook,
        config: {
          action: data => this.createWebhookWithPopup({ data }),
        },
      });
    },

    showEditWebhookModal(webhook) {
      this.$modals.show({
        name: MODALS.createWebhook,
        config: {
          webhook,

          action: data => this.updateWebhookWithPopup({ id: webhook._id, data }),
        },
      });
    },

    showDuplicateWebhookModal(webhook) {
      this.$modals.show({
        name: MODALS.createWebhook,
        config: {
          webhook,

          isDuplicating: true,
          action: data => this.createWebhookWithPopup({ data }),
        },
      });
    },

    showDeleteWebhookModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeWebhookWithPopup({ id }),
        },
      });
    },

    showDeleteSelectedWebhooksModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeSelectedWebhooksWithPopup(selected),
        },
      });
    },

    async createWebhookWithPopup({ data }) {
      await this.createWebhook({ data });
      this.$popups.success({ text: this.$t('modals.createWebhook.create.success') });
      this.refreshWebhooksList();
    },

    async updateWebhookWithPopup({ id, data }) {
      await this.updateWebhook({ id, data });
      this.$popups.success({ text: this.$t('modals.createWebhook.edit.success') });
      this.refreshWebhooksList();
    },

    async removeWebhookWithPopup({ id }) {
      await this.removeWebhook({ id });
      this.$popups.success({ text: this.$t('modals.createWebhook.remove.success') });
      this.refreshWebhooksList();
    },

    async removeSelectedWebhooksWithPopup(selected) {
      await Promise.all(selected.map(({ _id: id }) => this.removeWebhook({ id })));
      this.$popups.success({ text: this.$t('modals.createWebhook.remove.success') });
      this.refreshWebhooksList();
    },
  },
};
</script>

