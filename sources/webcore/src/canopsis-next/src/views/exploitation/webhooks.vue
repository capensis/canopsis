<template lang="pug">
  v-container
    h2.text-xs-center.my-3.display-1.font-weight-medium {{ $t('webhook.title') }}
    v-data-table(
    :items="webhooks",
    item-key="_id",
    :headers="headers",
    :loading="webhooksPending",
    expand
    )
      template(slot="items", slot-scope="props")
        tr(@click="props.expanded = !props.expanded")
          td {{ props.item._id }}
          td {{ props.item.request.method }}
          td {{ props.item.request.url }}
          td
            v-layout
              v-btn(
              v-if="hasUpdateAnyWebhookAccess",
              icon,
              small,
              @click.stop="showEditWebhookModal(props.item)"
              )
                v-icon edit
              v-btn(
              v-if="hasDeleteAnyWebhookAccess",
              icon,
              small,
              @click.stop="showRemoveWebhookModal(props.item._id)"
              )
                v-icon.error--text delete
      template(slot="expand", slot-scope="{ item }")
        webhook-form(:form="item | webhookToForm", dark, disabled)
    .fab
      v-layout(column)
        refresh-btn(@click="refreshWebhooksList")
        v-tooltip(v-if="hasCreateAnyWebhookAccess", left)
          v-btn(slot="activator", @click="showCreateWebhookModal", color="primary", dark, fab, icon)
            v-icon add
          span {{ $t('modals.createWebhook.create.title') }}
</template>

<script>
import { MODALS } from '@/constants';

import modalMixin from '@/mixins/modal';
import entitiesWebhookMixin from '@/mixins/entities/webhook';
import webhookFormFiltersMixin from '@/mixins/webhook/form-filters';
import rightsTechnicalExploitationWebhookMixin from '@/mixins/rights/technical/exploitation/webhook';

import WebhookForm from '@/components/other/webhook/form/webhook-form.vue';
import RefreshBtn from '@/components/other/view/refresh-btn.vue';

export default {
  components: {
    WebhookForm,
    RefreshBtn,
  },
  mixins: [
    modalMixin,
    entitiesWebhookMixin,
    webhookFormFiltersMixin,
    rightsTechnicalExploitationWebhookMixin,
  ],
  data() {
    return {
      headers: [
        {
          text: this.$t('webhook.table.headers.id'),
          value: '_id',
        },
        {
          text: this.$t('webhook.table.headers.requestMethod'),
          value: 'request.method',
        },
        {
          text: this.$t('webhook.table.headers.requestUrl'),
          value: 'request.url',
        },
        {
          text: this.$t('common.actionsLabel'),
          sortable: false,
        },
      ],
    };
  },
  mounted() {
    this.fetchWebhooksList();
  },
  methods: {
    showCreateWebhookModal() {
      this.showModal({
        name: MODALS.createWebhook,
        config: {
          action: data => this.createWebhookWithPopup({ data }),
        },
      });
    },

    showEditWebhookModal(webhook) {
      this.showModal({
        name: MODALS.createWebhook,
        config: {
          webhook,
          action: data => this.updateWebhookWithPopup({ id: webhook._id, data }),
        },
      });
    },

    showRemoveWebhookModal(id) {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeWebhookWithPopup({ id }),
        },
      });
    },

    async createWebhookWithPopup({ data }) {
      await this.createWebhook({ data });
      this.addSuccessPopup({ text: this.$t('modals.createWebhook.create.success') });
      this.refreshWebhooksList();
    },

    async removeWebhookWithPopup({ id }) {
      await this.removeWebhook({ id });
      this.addSuccessPopup({ text: this.$t('modals.createWebhook.duplicate.success') });
      this.refreshWebhooksList();
    },

    async updateWebhookWithPopup({ id, data }) {
      await this.updateWebhook({ id, data });
      this.addSuccessPopup({ text: this.$t('modals.createWebhook.edit.success') });
      this.refreshWebhooksList();
    },
  },
};
</script>

