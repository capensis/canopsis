<template lang="pug">
  div
    h2.text-xs-center.my-3.display-1.font-weight-medium {{ $t('eventFilter.title') }}
    v-data-table(
    :items="eventFilterRules",
    item-key="_id",
    :headers="headers",
    :loading="eventFilterRulesPending",
    expand
    )
      template(slot="items", slot-scope="props")
        tr(@click="props.expanded = !props.expanded")
          td {{ props.item._id }}
          td {{ props.item.type }}
          td {{ props.item.priority }}
          td
            v-icon(v-if="isRuleEnabled(props.item)", color="primary") check_circle
            v-icon(v-else, color="error") cancel
          td
            v-layout
              v-btn(
              v-if="hasUpdateAnyEventFilterAccess",
              icon,
              small,
              @click.stop="showEditRuleModal(props.item)"
              )
                v-icon edit
              v-btn(
              v-if="hasCreateAnyEventFilterAccess",
              icon,
              small,
              @click.stop="showDuplicateRuleModal(props.item)"
              )
                v-icon file_copy
              v-btn(
              v-if="hasDeleteAnyEventFilterAccess",
              icon,
              small,
              @click.stop="showRemoveRuleModal(props.item._id)"
              )
                v-icon.error--text delete
      template(slot="expand", slot-scope="props")
        v-tabs(color="secondary lighten-1", dark, centered)
          v-tab {{ $t('common.description') }}
          v-tab {{ $t('eventFilter.pattern') }}
          v-tab(
          :disabled="!(props.item.type === $constants.EVENT_FILTER_RULE_TYPES.enrichment)",
          ) {{ $t('eventFilter.externalDatas') }}
          v-tab(
          :disabled="!(props.item.type === $constants.EVENT_FILTER_RULE_TYPES.enrichment)",
          ) {{ $t('eventFilter.actions') }}
          v-tab-item
            v-layout.py-3.secondary.lighten-2(row)
              v-textarea.my-2.mx-4.pa-0(
              :value="props.item.description",
              readonly,
              auto-grow,
              outline,
              hide-details,
              dark,
              )
          v-tab-item
            v-layout.py-3.secondary.lighten-2(row)
              v-textarea.my-2.mx-4.pa-0(
              :value="props.item.pattern | json",
              readonly,
              auto-grow,
              outline,
              hide-details,
              dark,
              )
          v-tab-item
            v-layout.py-3.secondary.lighten-2(row)
              v-textarea.my-2.mx-4.pa-0(
              :value="props.item.external_data | json",
              readonly,
              auto-grow,
              outline,
              hide-details,
              dark,
              )
          v-tab-item
            v-layout.py-3.secondary.lighten-2(row, justify-center)
              v-flex(xs11)
                v-data-table(:items="props.item.actions", hide-headers)
                  template(slot="items", slot-scope="props")
                    td(v-for="(value, key) in props.item")
                      span.font-weight-bold.text-capitalize {{ key }} :
                      span  {{ value }}
    .fab
      v-layout(column)
        refresh-btn(@click="fetchEventFilterRulesList")
        v-tooltip(v-if="hasCreateAnyEventFilterAccess", left)
          v-btn(slot="activator", @click="showCreateRuleModal", color="primary", dark, fab, icon)
            v-icon add
          span {{ $t('modals.eventFilterRule.create.title') }}
</template>

<script>
import { has } from 'lodash';

import { MODALS } from '@/constants';

import modalMixin from '@/mixins/modal';
import entitiesEventFilterRuleMixin from '@/mixins/entities/event-filter-rule';
import rightsTechnicalExploitationEventFilterMixin from '@/mixins/rights/technical/exploitation/event-filter';

import RefreshBtn from '@/components/other/view/refresh-btn.vue';

export default {
  components: {
    RefreshBtn,
  },
  mixins: [
    modalMixin,
    entitiesEventFilterRuleMixin,
    rightsTechnicalExploitationEventFilterMixin,
  ],
  data() {
    return {
      headers: [
        {
          text: this.$t('eventFilter.id'),
          value: '_id',
        },
        {
          text: this.$t('eventFilter.type'),
          value: 'type',
        },
        {
          text: this.$t('eventFilter.priority'),
          value: 'priority',
        },
        {
          text: this.$t('eventFilter.enabled'),
          value: 'enabled',
        },
        {
          text: this.$t('eventFilter.actions'),
          sortable: false,
        },
      ],
    };
  },
  computed: {
    isRuleEnabled() {
      return rule => !has(rule, 'enabled') || rule.enabled;
    },
  },
  mounted() {
    this.fetchEventFilterRulesList();
  },
  methods: {
    showCreateRuleModal() {
      this.showModal({
        name: MODALS.createEventFilterRule,
        config: {
          title: this.$t('modals.eventFilterRule.create.title'),
          action: data => this.createEventFilterRuleWithPopup({ data }),
        },
      });
    },

    showDuplicateRuleModal(rule) {
      this.showModal({
        name: MODALS.createEventFilterRule,
        config: {
          title: this.$t('modals.eventFilterRule.duplicate.title'),
          rule,
          action: data => this.duplicateEventFilterRuleWithPopup({ data }),
        },
      });
    },

    showEditRuleModal(rule) {
      this.showModal({
        name: MODALS.createEventFilterRule,
        config: {
          title: this.$t('modals.eventFilterRule.edit.title'),
          rule,
          action: data => this.updateEventFilterRuleWithPopup({ id: rule._id, data }),
        },
      });
    },

    showRemoveRuleModal(ruleId) {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeEventFilterRuleWithPopup({ id: ruleId }),
        },
      });
    },

    async createEventFilterRuleWithPopup({ data }) {
      await this.createEventFilterRule({ data });
      this.addSuccessPopup({ text: this.$t('modals.eventFilterRule.create.success') });
      this.refreshEventFilterRulesList();
    },

    async duplicateEventFilterRuleWithPopup({ data }) {
      await this.createEventFilterRule({ data });
      this.addSuccessPopup({ text: this.$t('modals.eventFilterRule.duplicate.success') });
      this.refreshEventFilterRulesList();
    },

    async updateEventFilterRuleWithPopup({ id, data }) {
      await this.updateEventFilterRule({ id, data });
      this.addSuccessPopup({ text: this.$t('modals.eventFilterRule.edit.success') });
      this.refreshEventFilterRulesList();
    },

    async removeEventFilterRuleWithPopup({ id }) {
      await this.removeEventFilterRule({ id });
      this.addSuccessPopup({ text: this.$t('modals.eventFilterRule.remove.success') });
      this.refreshEventFilterRulesList();
    },
  },
};
</script>
