<template lang="pug">
  div
    h2.text-xs-center.my-3.display-1.font-weight-medium {{ $t('eventFilter.title') }}
    v-data-table(
    :items="eventFilterRules",
    item-key="_id"
    :headers="headers",
    :loading="eventFilterRulesPending",
    expand
    )
      template(slot="items", slot-scope="props")
        tr(@click="props.expanded = !props.expanded")
          td {{ props.item.type }}
          td {{ props.item.priority }}
          td
            v-icon(v-if="props.item.enabled", color="primary") check_circle
            v-icon(v-else, color="error") cancel
          td
            v-layout
              v-btn(@click.stop="showEditRuleModal(props.item)", icon, small)
                v-icon edit
              v-btn(@click.stop="showDuplicateRuleModal(props.item)", icon, small)
                v-icon file_copy
              v-btn(@click.stop="showRemoveRuleModal(props.item._id)", icon, small)
                v-icon.error--text delete
      template(slot="expand", slot-scope="props")
        v-tabs(centered)
          v-tab Pattern
          v-tab(:disabled="!(props.item.type === $constants.EVENT_FILTER_RULE_TYPES.enrichment)") External datas
          v-tab(:disabled="!(props.item.type === $constants.EVENT_FILTER_RULE_TYPES.enrichment)") Actions
          v-tab-item
            v-textarea.my-2.mx-4.pa-0(
            :value="JSON.stringify(props.item.pattern, undefined, 4)",
            readonly,
            auto-grow,
            outline,
            hide-details
            )
          v-tab-item
            v-textarea.my-2.mx-4.pa-0(
            :value="JSON.stringify(props.item.external_data, undefined, 4)",
            readonly,
            auto-grow,
            outline,
            hide-details
            )
          v-tab-item
            v-data-table(:items="props.item.actions", hide-headers)
              template(slot="items", slot-scope="props")
                td(v-for="(value, key) in props.item")
                  span.font-weight-bold.text-capitalize {{ key }} :
                  span  {{ value }}
    .fab
      v-layout(column)
        refresh-btn(@click="fetchEventFilterRulesList")
        v-tooltip(left)
          v-btn(slot="activator", @click="showCreateRuleModal", color="primary", dark, fab, icon)
            v-icon add
          span {{ $t('modals.eventFilterRule.create.title') }}
</template>

<script>
import { MODALS } from '@/constants';

import modalMixin from '@/mixins/modal';
import entitiesEventFilterMixin from '@/mixins/entities/event-filter';

import RefreshBtn from '@/components/other/view/refresh-btn.vue';

export default {
  components: {
    RefreshBtn,
  },
  mixins: [modalMixin, entitiesEventFilterMixin],
  data() {
    return {
      headers: [
        {
          text: this.$t('eventFilter.type'),
          value: 'type',
        },
        {
          text: this.$t('eventFilter.priority'),
          value: 'priority',
        },
        {
          text: this.$t('eventFilter.enabled'),
          value: 'enabled',
        },
        {
          text: this.$t('eventFilter.actions'),
          sortable: false,
        },
      ],
    };
  },
  mounted() {
    this.fetchEventFilterRulesList();
  },
  methods: {
    showCreateRuleModal() {
      this.showModal({
        name: MODALS.createEventFilterRule,
        config: {
          title: this.$t('modals.eventFilterRule.create.title'),
          action: data => this.createEventFilterRuleWithPopupWithRefresh({ data }),
        },
      });
    },

    showDuplicateRuleModal(rule) {
      this.showModal({
        name: MODALS.createEventFilterRule,
        config: {
          title: this.$t('modals.eventFilterRule.duplicate.title'),
          rule,
          action: data => this.duplicateEventFilterRuleWithPopupWithRefresh({ data }),
        },
      });
    },

    showRemoveRuleModal(ruleId) {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeEventFilterRuleWithPopupWithRefresh({ id: ruleId }),
        },
      });
    },

    showEditRuleModal(rule) {
      this.showModal({
        name: MODALS.createEventFilterRule,
        config: {
          title: this.$t('modals.eventFilterRule.edit.title'),
          rule,
          action: data => this.updateEventFilterRuleWithPopupWithRefresh({ id: rule._id, data }),
        },
      });
    },
  },
};
</script>
