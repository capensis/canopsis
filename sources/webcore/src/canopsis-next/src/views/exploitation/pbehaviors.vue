<template lang="pug">
  div
    div
      h2.text-xs-center.my-3.display-1.font-weight-medium {{ $t('common.pbehaviors') }}
      div.white
        v-layout(row, wrap)
          v-flex(xs4)
            search-field(v-model="searchingText")
          v-flex(v-show="selected.length", xs4)
            v-btn(@click="showDeleteSelectedPbehaviorsModal", icon)
              v-icon(color="error") delete
        v-data-table(
        v-model="selected",
        :items="pbehaviors",
        :loading="pbehaviorsPending",
        :headers="headers",
        :pagination.sync="vDataTablePagination",
        :search="searchingText",
        :custom-filter="tableFilter",
        item-key="_id",
        hide-actions,
        select-all,
        expand
        )
          template(slot="progress")
            v-fade-transition
              v-progress-linear(height="2", indeterminate, color="primary")
          template(slot="items", slot-scope="props")
            tr(@click="props.expanded = !props.expanded")
              td(@click.stop="")
                v-checkbox(v-model="props.selected", primary, hide-details)
              td
                ellipsis(:text="props.item.name")
              td {{ props.item.author }}
              td {{ props.item.connector }}
              td {{ props.item.connector_name }}
              td
                v-icon(v-if="props.item.enabled", color="primary") check_circle
                v-icon(v-else, color="error") cancel
              td {{ props.item.tstart | date('long') }}
              td {{ props.item.tstop | date('long') }}
              td {{ props.item.type_ }}
              td {{ props.item.reason }}
              td
                v-icon {{ props.item.rrule ? 'check' : 'clear' }}
              td
                v-layout
                  v-flex
                    v-btn(@click.stop="showEditPbehaviorModal(props.item)", icon, small)
                      v-icon edit
                    v-btn.error--text(@click="showDeletePbehaviorModal(props.item._id)", icon, small)
                      v-icon(color="error") delete
          template(slot="expand", slot-scope="props")
            v-tabs(color="secondary lighten-1", dark, centered)
              v-tab {{ $t('pbehaviors.tabs.filter') }}
              v-tab {{ $t('pbehaviors.tabs.eids') }}
              v-tab {{ $t('pbehaviors.tabs.comments') }}
              v-tab-item
                v-layout.py-3.secondary.lighten-2(row)
                  v-flex(xs12, sm10, offset-sm1)
                    v-card
                      v-card-text
                        pre {{ props.item.filter | json }}
              v-tab-item
                v-layout.py-3.secondary.lighten-2(row)
                  v-flex(xs12, sm8, offset-sm2)
                    v-card
                      v-card-text
                        v-data-iterator(:items="props.item.eids")
                          v-flex(slot="item", slot-scope="props")
                            v-card
                              v-card-title {{ props.item }}
                          v-flex(slot="no-data")
                            v-card
                              v-card-title {{ $t('tables.noData') }}
              v-tab-item
                v-layout.py-3.secondary.lighten-2(row)
                  v-flex(xs12, sm6, offset-sm3)
                    v-card
                      v-card-text.pa-0
                        v-list(two-line)
                          v-list-tile(v-if="!props.item.comments || !props.item.comments.length")
                            v-list-tile-content
                              v-list-tile-title {{ $t('tables.noData') }}
                          template(v-for="(comment, index) in props.item.comments")
                            v-list-tile(:key="comment._id")
                              v-list-tile-content
                                v-list-tile-title {{ comment.author }}
                                v-list-tile-sub-title {{ comment.message }}
                            v-divider(v-if="index < props.item.comments.length - 1", :key="`divider-${index}`")
      pagination(
      :page="query.page",
      :limit="query.limit",
      :total="query.totalItems",
      @input="updateQueryPage"
      )
    .fab
      v-layout(column)
        refresh-btn(@click="refresh")
        v-tooltip(left)
          v-btn(slot="activator", color="primary", fab, dark, @click.stop="showCreatePbehaviorModal")
            v-icon add
          span {{ $t('common.addPbehavior') }}
</template>

<script>
import { pick } from 'lodash';

import { PAGINATION_LIMIT } from '@/config';
import { MODALS } from '@/constants';

import modalMixin from '@/mixins/modal';
import pbehaviorsEntityMixin from '@/mixins/entities/pbehavior';
import widgetPaginationMixin from '@/mixins/widget/pagination';

import Ellipsis from '@/components/tables/ellipsis.vue';
import SearchField from '@/components/forms/fields/search-field.vue';
import RefreshBtn from '@/components/other/view/refresh-btn.vue';

export default {
  components: {
    Ellipsis,
    SearchField,
    RefreshBtn,
  },
  mixins: [
    modalMixin,
    pbehaviorsEntityMixin,
    widgetPaginationMixin,
  ],
  data() {
    return {
      searchingText: '',
      query: {
        limit: PAGINATION_LIMIT,
        page: 1,
        descending: false,
        sortBy: null,
      },
      headers: [
        {
          text: this.$t('common.name'),
          value: 'name',
        },
        {
          text: this.$t('common.author'),
          value: 'author',
        },
        {
          text: this.$t('pbehaviors.connector'),
          value: 'connector',
        },
        {
          text: this.$t('pbehaviors.connectorName'),
          value: 'connector_name',
        },
        {
          text: this.$t('pbehaviors.isEnabled'),
          value: 'enabled',
        },
        {
          text: this.$t('pbehaviors.begins'),
          value: 'tstart',
        },
        {
          text: this.$t('pbehaviors.ends'),
          value: 'tstop',
        },
        {
          text: this.$t('pbehaviors.type'),
          value: 'type',
        },
        {
          text: this.$t('pbehaviors.reason'),
          value: 'reason',
        },
        {
          text: this.$t('pbehaviors.rrule'),
          value: 'rrule',
        },
        {
          text: this.$t('common.actionsLabel'),
          value: 'actions',
        },
      ],
      selected: [],
    };
  },
  computed: {
    vDataTablePagination: {
      get() {
        return {
          ...pick(this.query, ['page', 'descending', 'sortBy', 'totalItems']),

          rowsPerPage: this.query.limit,
        };
      },
      set(value) {
        this.query = {
          ...pick(value, ['page', 'descending', 'sortBy', 'totalItems']),

          limit: value.rowsPerPage,
        };
      },
    },
  },
  watch: {
    query() {
      this.selected = [];
    },
  },
  mounted() {
    this.fetchItems();
  },
  methods: {
    tableFilter(items = [], search = '') {
      const searchInLowerCase = search.toLowerCase();

      if (searchInLowerCase.length === 0) {
        return items;
      }

      return items.filter(({ name = '', reason = '', eids = [] } = {}) => {
        const foundInName = name.toLowerCase().indexOf(searchInLowerCase) >= 0;
        const foundInReason = reason.toLowerCase().indexOf(searchInLowerCase) >= 0;
        const foundInEids = eids.filter(eid => eid.toLowerCase().indexOf(searchInLowerCase) >= 0).length > 0;

        return foundInName || foundInReason || foundInEids;
      });
    },

    async fetchItems() {
      await this.fetchPbehaviorsList();

      this.$nextTick(() => this.query.totalItems = this.pbehaviorsMeta.total);
    },

    showDeletePbehaviorModal(id) {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: () => this.removePbehavior({ id }),
        },
      });
    },

    showDeleteSelectedPbehaviorsModal() {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await Promise.all(this.selected.map(pbehavior => this.removePbehavior({ id: pbehavior._id })));

            this.selected = [];
          },
        },
      });
    },

    showCreatePbehaviorModal() {
      this.showModal({
        name: MODALS.createPbehavior,
      });
    },

    showEditPbehaviorModal(pbehavior) {
      this.showModal({
        name: MODALS.createPbehavior,
        config: {
          pbehavior,
        },
      });
    },

    refresh() {
      this.fetchItems();
    },
  },
};
</script>

