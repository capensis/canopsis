<template lang="pug">
  v-container
    div
      h2.text-xs-center.my-3.display-1.font-weight-medium {{ $t('common.pbehaviors') }}
      div.white
        v-layout(row, wrap)
          v-flex(xs4)
            search-field(v-model="searchingText")
          v-flex(v-show="selected.length", xs4)
            v-btn(@click="deleteSelectedPbehaviors", icon)
              v-icon(color="error") delete
        v-data-table(
        v-model="selected",
        :items="pbehaviors",
        :loading="pbehaviorsPending",
        :headers="headers",
        :pagination.sync="vDataTablePagination",
        :search="searchingText",
        item-key="_id",
        hide-actions,
        select-all
        )
          template(slot="progress")
            v-fade-transition
              v-progress-linear(height="2", indeterminate, color="primary")
          template(slot="items", slot-scope="props")
            td
              v-checkbox(primary, hide-details, v-model="props.selected")
            td {{ props.item.author }}
            td {{ props.item.connector_name }}
            td {{ props.item.name }}
            td {{ props.item.reason }}
            td {{ props.item.type }}
            td
              v-layout
                v-flex
                  v-btn.error--text(@click="deletePbehavior(props.item._id)", icon, small)
                    v-icon(color="error") delete
      pagination(:query.sync="query", :meta="meta")
    .fab
      v-tooltip(left)
        v-btn(slot="activator", color="primary", fab, dark, @click.stop="showCreatePbehaviorModal")
          v-icon add
        span {{ $t('common.addPbehavior') }}

</template>

<script>
import pick from 'lodash/pick';

import { PAGINATION_LIMIT } from '@/config';
import { MODALS } from '@/constants';

import modalMixin from '@/mixins/modal';
import pbehaviorsEntityMixin from '@/mixins/entities/pbehavior';

import Pagination from '@/components/tables/pagination.vue';
import SearchField from '@/components/forms/fields/search-field.vue';

export default {
  components: {
    Pagination,
    SearchField,
  },
  mixins: [modalMixin, pbehaviorsEntityMixin],
  data() {
    return {
      searchingText: '',
      query: {
        limit: PAGINATION_LIMIT,
        page: 1,
        descending: false,
        sortBy: null,
      },
      headers: [
        {
          text: this.$t('common.author'),
          value: 'author',
        },
        {
          text: this.$t('pbehaviors.connectorName'),
          value: 'connector_name',
        },
        {
          text: this.$t('common.name'),
          value: 'name',
        },
        {
          text: this.$t('pbehaviors.reason'),
          value: 'reason',
        },
        {
          text: this.$t('pbehaviors.type'),
          value: 'type',
        },
        {
          text: this.$t('common.actionsLabel'),
          value: 'actions',
        },
      ],
      selected: [],
    };
  },
  computed: {
    vDataTablePagination: {
      get() {
        return {
          ...pick(this.query, ['page', 'descending', 'sortBy', 'totalItems']),

          rowsPerPage: this.query.limit,
        };
      },
      set(value) {
        this.query = {
          ...pick(value, ['page', 'descending', 'sortBy', 'totalItems']),

          limit: value.rowsPerPage,
        };
      },
    },

    meta() {
      return {
        total: this.query.totalItems,
      };
    },
  },
  watch: {
    query() {
      this.selected = [];
    },
  },
  async mounted() {
    await this.fetchPbehaviorsList();

    this.$nextTick(() => this.query.totalItems = this.pbehaviorsMeta.total);
  },
  methods: {
    deletePbehavior(id) {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: () => this.removePbehavior({ id }),
        },
      });
    },

    deleteSelectedPbehaviors() {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await Promise.all(this.selected.map(id => this.removePbehavior({ id })));

            this.selected = [];
          },
        },
      });
    },

    showCreatePbehaviorModal() {
      this.showModal({
        name: MODALS.createPbehavior,
      });
    },
  },
};
</script>

