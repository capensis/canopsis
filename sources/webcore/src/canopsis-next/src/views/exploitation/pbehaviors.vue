<template lang="pug">
  div
    pbehaviors-list(
    :pbehaviors="pbehaviors",
    :meta="pbehaviorsMeta",
    :pending="pbehaviorsPending",
    :showEditPbehaviorModal="showEditPbehaviorModal",
    :showDeletePbehaviorModal="showDeletePbehaviorModal",
    :showDeleteSelectedPbehaviorsModal="showDeleteSelectedPbehaviorsModal",
    )
    .fab
      v-layout(column)
        refresh-btn(@click="fetchList")
        v-tooltip(v-if="hasCreateAnyPbehaviorAccess", left)
          v-btn(
          slot="activator",
          color="primary",
          fab,
          dark,
          @click.stop="showCreatePbehaviorModal"
          )
            v-icon add
          span {{ $t('common.addPbehavior') }}
</template>

<script>
import { MODALS } from '@/constants';

import modalMixin from '@/mixins/modal';
import popupMixin from '@/mixins/popup';
import entitiesPbehaviorMixin from '@/mixins/entities/pbehavior';
import entitiesPbehaviorCommentMixin from '@/mixins/entities/pbehavior/comment';
import rightsTechnicalExploitationPbehaviorMixin from '@/mixins/rights/technical/exploitation/pbehavior';

import RefreshBtn from '@/components/other/view/refresh-btn.vue';
import PbehaviorsList from '@/components/other/pbehavior/exploitation/pbehaviors-list.vue';

export default {
  components: {
    RefreshBtn,
    PbehaviorsList,
  },
  mixins: [
    modalMixin,
    popupMixin,
    entitiesPbehaviorMixin,
    entitiesPbehaviorCommentMixin,
    rightsTechnicalExploitationPbehaviorMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    showCreatePbehaviorModal() {
      this.showModal({
        name: MODALS.createPbehavior,
        config: {
          action: async (data) => {
            await this.createPbehavior({ data });

            this.fetchList();
            this.addSuccessPopup({ text: this.$t('success.default') });
          },
        },
      });
    },

    showEditPbehaviorModal(pbehavior) {
      this.showModal({
        name: MODALS.createPbehavior,
        config: {
          pbehavior,

          action: async (data) => {
            const { comments, ...preparedData } = data;

            await this.updatePbehavior({ data: preparedData, id: pbehavior._id });
            await this.updateSeveralPbehaviorComments({ pbehavior, comments });

            this.fetchList();
            this.addSuccessPopup({ text: this.$t('success.default') });
          },
        },
      });
    },


    showDeletePbehaviorModal(id) {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: () => this.removePbehavior({ id }),
        },
      });
    },

    showDeleteSelectedPbehaviorsModal(selected) {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await Promise.all(selected.map(pbehavior => this.removePbehavior({ id: pbehavior._id })));

            this.selected = [];
          },
        },
      });
    },

    fetchList() {
      this.fetchPbehaviorsList();
    },
  },
};
</script>

