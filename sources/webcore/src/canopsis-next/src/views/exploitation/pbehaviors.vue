<template lang="pug">
  div
    pbehaviors-list(
      :query.sync="query",
      :showEditPbehaviorModal="showEditPbehaviorModal",
      :showDuplicatePbehaviorModal="showDuplicatePbehaviorModal",
      :showDeletePbehaviorModal="showDeletePbehaviorModal",
      :showDeleteSelectedPbehaviorsModal="showDeleteSelectedPbehaviorsModal"
    )
    .fab
      v-layout(column)
        refresh-btn(@click="fetchList")
        v-tooltip(v-if="hasCreateAnyPbehaviorAccess", left)
          v-btn(
            slot="activator",
            color="primary",
            fab,
            dark,
            @click.stop="showCreatePbehaviorModal"
          )
            v-icon add
          span {{ $t('common.addPbehavior') }}
</template>

<script>
import { isEmpty, isEqual } from 'lodash';
import { MODALS, SORT_ORDERS } from '@/constants';
import { PAGINATION_LIMIT } from '@/config';

import entitiesPbehaviorMixin from '@/mixins/entities/pbehavior';
import entitiesPbehaviorCommentMixin from '@/mixins/entities/pbehavior/comment';
import rightsTechnicalExploitationPbehaviorMixin from '@/mixins/rights/technical/exploitation/pbehavior';

import RefreshBtn from '@/components/other/view/buttons/refresh-btn.vue';
import PbehaviorsList from '@/components/other/pbehavior/exploitation/pbehaviors-list.vue';

export default {
  components: {
    RefreshBtn,
    PbehaviorsList,
  },
  mixins: [
    entitiesPbehaviorMixin,
    entitiesPbehaviorCommentMixin,
    rightsTechnicalExploitationPbehaviorMixin,
  ],
  data() {
    return {
      query: {
        page: 1,
        limit: PAGINATION_LIMIT,
        search: '',
      },
    };
  },
  watch: {
    query(value, oldValue) {
      if (!isEqual(value, oldValue) && !isEmpty(value)) {
        this.fetchList();
      }
    },
  },
  mounted() {
    this.fetchList();
  },
  methods: {
    showCreatePbehaviorModal() {
      this.$modals.show({
        name: MODALS.createPbehavior,
        config: {
          action: async (data) => {
            await this.createPbehavior({ data });

            this.fetchList();
            this.$popups.success({ text: this.$t('success.default') });
          },
        },
      });
    },

    showEditPbehaviorModal(pbehavior) {
      this.$modals.show({
        name: MODALS.createPbehavior,
        config: {
          pbehavior,

          action: async (data) => {
            const { comments, ...preparedData } = data;

            await this.updatePbehavior({ data: preparedData, id: pbehavior._id });
            await this.updateSeveralPbehaviorComments({ pbehavior, comments });

            this.fetchList();
            this.$popups.success({ text: this.$t('success.default') });
          },
        },
      });
    },

    showDuplicatePbehaviorModal(pbehavior) {
      this.$modals.show({
        name: MODALS.createPbehavior,
        config: {
          pbehavior,

          isDuplicating: true,
          action: async (data) => {
            await this.createPbehavior({ data });

            this.fetchList();
            this.$popups.success({ text: this.$t('success.default') });
          },
        },
      });
    },


    showDeletePbehaviorModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removePbehavior({ id }),
        },
      });
    },

    showDeleteSelectedPbehaviorsModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await Promise.all(selected.map(pbehavior => this.removePbehavior({ id: pbehavior._id })));

            this.selected = [];
          },
        },
      });
    },

    getQuery() {
      const query = {};

      const {
        page,
        limit = PAGINATION_LIMIT,
        search,
        sortKey,
        sortDir = SORT_ORDERS.asc,
      } = this.query;

      query.limit = limit;
      query.skip = ((page - 1) * limit) || 0;

      if (search) {
        query.search = search;
      }

      if (sortKey) {
        query.property = sortKey;
        query.direction = sortDir;
      }

      return query;
    },

    fetchList() {
      const query = this.getQuery();
      this.fetchPbehaviorsList({ params: query });
    },
  },
};
</script>

