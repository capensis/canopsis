<template lang="pug">
  div
    pbehaviors-list(
    :pbehaviors="pbehaviors",
    :meta="pbehaviorsMeta",
    :pending="pbehaviorsPending"
    )
    .fab
      v-layout(column)
        refresh-btn(@click="fetchList")
        v-tooltip(v-if="hasCreateAnyPbehaviorAccess", left)
          v-btn(slot="activator", color="primary", fab, dark, @click.stop="showCreatePbehaviorModal")
            v-icon add
          span {{ $t('common.addPbehavior') }}
</template>

<script>
import { MODALS } from '@/constants';

import modalMixin from '@/mixins/modal';
import entitiesPbehaviorMixin from '@/mixins/entities/pbehavior';
import entitiesPbehaviorCommentMixin from '@/mixins/entities/pbehavior/comment';

import RefreshBtn from '@/components/other/view/refresh-btn.vue';
import PbehaviorsList from '@/components/other/exploitation/pbehaviors/pbehaviors-list.vue';

export default {
  components: {
    RefreshBtn,
    PbehaviorsList,
  },
  mixins: [
    modalMixin,
    entitiesPbehaviorMixin,
    entitiesPbehaviorCommentMixin,
  ],
  mounted() {
    this.fetchList();
  },
  methods: {
    showCreatePbehaviorModal() {
      this.showModal({
        name: MODALS.createPbehavior,
        config: {
          action: async (data) => {
            await this.createPbehavior({ data });

            this.fetchList();
            this.addSuccessPopup({ text: this.$t('success.default') });
          },
        },
      });
    },

    showEditPbehaviorModal(pbehavior) {
      this.showModal({
        name: MODALS.createPbehavior,
        config: {
          pbehavior,

          action: async (data) => {
            const { comments, ...preparedData } = data;

            await this.updatePbehavior({ data: preparedData, id: pbehavior._id });
            await this.updateSeveralPbehaviorComments({ pbehavior, comments });

            this.fetchList();
            this.addSuccessPopup({ text: this.$t('success.default') });
          },
        },
      });
    },

    fetchList() {
      this.fetchPbehaviorsList();
    },
  },
};
</script>

