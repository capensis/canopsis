<template lang="pug">
  div
    div
      snmp-rules-list(
        :query.sync="query",
        :items="snmpRules",
        :meta="snmpRulesMeta",
        :pending="snmpRulesPending",
        :showEditSnmpRuleModal="showEditSnmpRuleModal",
        :showDeleteSnmpRuleModal="showDeleteSnmpRuleModal",
        :showDeleteSelectedSnmpRulesModal="showDeleteSelectedSnmpRulesModal"
      )
    .fab
      v-layout(column)
        refresh-btn(@click="fetchList")
        v-speed-dial(
          v-if="hasCreateAnySnmpRuleAccess || hasUpdateAnySnmpRuleAccess",
          v-model="isVSpeedDialOpen",
          direction="left",
          transition="slide-y-reverse-transition"
        )
          v-btn(slot="activator", :input-value="isVSpeedDialOpen", color="primary", dark, fab)
            v-icon menu
            v-icon close
          snmp-rules-upload-button(v-if="hasUpdateAnySnmpRuleAccess")
          v-tooltip(v-if="hasCreateAnySnmpRuleAccess", top)
            v-btn(
              slot="activator",
              color="primary",
              small,
              dark,
              fab,
              @click.stop="showCreateSnmpRuleModal"
            )
              v-icon add
            span {{ $t('snmpRules.addSnmpRule') }}
</template>

<script>
import { isEqual } from 'lodash';

import { PAGINATION_LIMIT } from '@/config';
import { MODALS } from '@/constants';

import modalMixin from '@/mixins/modal';
import entitiesSnmpRuleMixin from '@/mixins/entities/snmp-rule';
import rightsTechnicalExploitationSnmpRuleMixin from '@/mixins/rights/technical/exploitation/snmp-rule';


import SnmpRulesUploadButton from '@/components/other/snmp-rule/exploitation/snmp-rules-list-upload-button.vue';
import SnmpRulesList from '@/components/other/snmp-rule/exploitation/snmp-rules-list.vue';
import RefreshBtn from '@/components/other/view/refresh-btn.vue';

export default {
  components: { SnmpRulesUploadButton, SnmpRulesList, RefreshBtn },
  mixins: [
    modalMixin,
    entitiesSnmpRuleMixin,
    rightsTechnicalExploitationSnmpRuleMixin,
  ],
  data() {
    return {
      isVSpeedDialOpen: false,
      query: {
        limit: PAGINATION_LIMIT,
        page: 1,
      },
    };
  },
  watch: {
    query(value, oldValue) {
      if (!isEqual(value, oldValue)) {
        this.fetchList();
      }
    },
  },
  mounted() {
    this.fetchList();
  },
  methods: {
    showCreateSnmpRuleModal() {
      this.showModal({
        name: MODALS.createSnmpRule,
        config: {
          action: async (data) => {
            await this.createSnmpRule({ data });
            this.fetchList();
          },
        },
      });
    },

    showEditSnmpRuleModal(snmpRule) {
      this.showModal({
        name: MODALS.createSnmpRule,
        config: {
          snmpRule,

          action: async (data) => {
            await this.createSnmpRule({ data });
            this.fetchList();
          },
        },
      });
    },

    showDeleteSnmpRuleModal(id) {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.removeSnmpRule({ data: { ids: [id] } });
            this.fetchList();
          },
        },
      });
    },

    showDeleteSelectedSnmpRulesModal(selected = []) {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: async () => {
            await this.removeSnmpRule({ data: { ids: selected.map(({ _id }) => _id) } });
            this.fetchList();
          },
        },
      });
    },

    getQuery() {
      return {
        limit: this.query.limit,
        start: (this.query.page - 1) * this.query.limit,
      };
    },

    fetchList() {
      this.fetchSnmpRulesList({ params: this.getQuery() });
    },
  },
};
</script>
