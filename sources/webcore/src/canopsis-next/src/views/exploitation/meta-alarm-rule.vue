<template lang="pug">
  div
    meta-alarm-rule-list(
      :rules="metaAlarmRule",
      :pending="metaAlarmRulePending",
      :showEditRuleModal="showEditRuleModal",
      :showDuplicateRuleModal="showDuplicateRuleModal",
      :showDeleteRuleModal="showDeleteRuleModal",
      :showDeleteSelectedRulesModal="showDeleteSelectedRulesModal"
    )
    .fab
      v-layout(column)
        refresh-btn(@click="refreshMetaAlarmRuleList")
        v-tooltip(v-if="hasCreateAnyMetaAlarmRuleAccess", left)
          v-btn(slot="activator", @click="showCreateRuleModal", color="primary", dark, fab, icon)
            v-icon add
          span {{ $t('modals.metaAlarmRule.create.title') }}
</template>

<script>
import { MODALS } from '@/constants';

import entitiesMetaAlarmRuleMixin from '@/mixins/entities/meta-alarm-rule';
import rightsTechnicalExploitationMetaAlarmMixin from '@/mixins/rights/technical/exploitation/meta-alarm-rule';

import MetaAlarmRuleList from '@/components/other/meta-alarm-rule/exploitation/meta-alarm-rule-list.vue';
import RefreshBtn from '@/components/other/view/buttons/refresh-btn.vue';

export default {
  components: {
    MetaAlarmRuleList,
    RefreshBtn,
  },
  mixins: [
    entitiesMetaAlarmRuleMixin,
    rightsTechnicalExploitationMetaAlarmMixin,
  ],
  mounted() {
    this.fetchMetaAlarmRuleList();
  },
  methods: {
    showCreateRuleModal() {
      this.$modals.show({
        name: MODALS.createMetaAlarmRule,
        config: {
          title: this.$t('modals.metaAlarmRule.create.title'),
          action: data => this.createMetaAlarmRuleWithPopup({ data }),
        },
      });
    },

    showDuplicateRuleModal(rule) {
      this.$modals.show({
        name: MODALS.createMetaAlarmRule,
        config: {
          title: this.$t('modals.metaAlarmRule.duplicate.title'),
          rule,
          isDuplicating: true,
          action: data => this.duplicateMetaAlarmRuleWithPopup({ data }),
        },
      });
    },

    showEditRuleModal(rule) {
      this.$modals.show({
        name: MODALS.createMetaAlarmRule,
        config: {
          title: this.$t('modals.metaAlarmRule.edit.title'),
          rule,
          action: data => this.updateMetaAlarmRuleWithPopup({ id: rule._id, data }),
        },
      });
    },

    showDeleteRuleModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeMetaAlarmRuleWithPopup({ id }),
        },
      });
    },

    showDeleteSelectedRulesModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeSelectedMetaAlarmRuleWithPopup(selected),
        },
      });
    },

    async createMetaAlarmRuleWithPopup({ data }) {
      await this.createMetaAlarmRule({ data });
      this.$popups.success({ text: this.$t('modals.metaAlarmRule.create.success') });
      this.refreshMetaAlarmRuleList();
    },

    async duplicateMetaAlarmRuleWithPopup({ data }) {
      await this.createMetaAlarmRule({ data });
      this.$popups.success({ text: this.$t('modals.metaAlarmRule.duplicate.success') });
      this.refreshMetaAlarmRuleList();
    },

    async updateMetaAlarmRuleWithPopup({ id, data }) {
      await this.updateMetaAlarmRule({ id, data });
      this.$popups.success({ text: this.$t('modals.metaAlarmRule.edit.success') });
      this.refreshMetaAlarmRuleList();
    },

    async removeMetaAlarmRuleWithPopup({ id }) {
      // TODO '/' added for parsing a string on the backend
      await this.removeMetaAlarmRule({ id: `${id}/` });
      this.$popups.success({ text: this.$t('modals.metaAlarmRule.remove.success') });
      this.refreshMetaAlarmRuleList();
    },

    async removeSelectedMetaAlarmRuleWithPopup(selected) {
      await Promise.all(selected.map(({ _id: id }) => this.removeMetaAlarmRule({ id })));
      this.$popups.success({ text: this.$t('modals.metaAlarmRule.remove.success') });
      this.refreshMetaAlarmRuleList();
    },
  },
};
</script>
