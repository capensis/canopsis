<template lang="pug">
  v-container
    div
      h2.text-xs-center.my-3.display-1.font-weight-medium {{ $t('heartbeat.title') }}
      .white
        v-layout(row, wrap)
          v-flex(v-show="hasDeleteAnyHeartbeatAccess && selected.length", xs4)
            v-btn(icon, @click="showDeleteSelectedHeartbeatsModal(selected)")
              v-icon(color="error") delete
        v-data-table(
          v-model="selected",
          :items="heartbeats",
          :loading="heartbeatsPending",
          :headers="headers",
          item-key="_id",
          select-all,
          expand
        )
          template(slot="progress")
            v-fade-transition
              v-progress-linear(height="2", indeterminate, color="primary")
          template(slot="items", slot-scope="props")
            tr(@click="props.expanded = !props.expanded")
              td(@click.stop="")
                v-checkbox-functional(v-model="props.selected", primary, hide-details)
              td {{ props.item._id }}
              td {{ props.item.expected_interval }}
              td
                v-layout
                  v-flex
                    v-btn.error--text(
                      v-if="hasDeleteAnyHeartbeatAccess",
                      icon,
                      small,
                      @click.stop="showDeleteHeartbeatModal(props.item._id)"
                    )
                      v-icon(color="error") delete
          template(slot="expand", slot-scope="props")
            .secondary.lighten-1
              v-layout.py-3.secondary.lighten-2(row)
                v-textarea.my-2.mx-4.pa-0(
                  :value="props.item.pattern | json",
                  readonly,
                  auto-grow,
                  outline,
                  hide-details,
                  dark
                )
    .fab
      v-layout(column)
        refresh-btn(@click="refreshHeartbeatsList")
        v-tooltip(v-if="hasCreateAnyHeartbeatAccess", left)
          v-btn(slot="activator", @click="showCreateHeartbeatModal", color="primary", dark, fab, icon)
            v-icon add
          span {{ $t('modals.createHeartbeat.create.title') }}
</template>

<script>
import { MODALS } from '@/constants';

import modalMixin from '@/mixins/modal';
import entitiesHeartbeatMixin from '@/mixins/entities/heartbeat';
import rightsTechnicalExploitationHeartbeatMixin from '@/mixins/rights/technical/exploitation/heartbeat';

import WebhooksList from '@/components/other/webhook/exploitation/webhooks-list.vue';
import RefreshBtn from '@/components/other/view/refresh-btn.vue';

export default {
  components: {
    WebhooksList,
    RefreshBtn,
  },
  mixins: [
    modalMixin,
    entitiesHeartbeatMixin,
    rightsTechnicalExploitationHeartbeatMixin,
  ],
  data() {
    return {
      query: {},
      selected: [],
    };
  },
  computed: {
    headers() {
      return [
        { text: this.$t('common.id'), value: '_id' },
        { text: this.$t('common.expectedInterval'), value: 'expected_interval' },
        { text: this.$t('common.actionsLabel'), value: 'actions' },
      ];
    },
  },
  mounted() {
    this.fetchHeartbeatsList();
  },
  methods: {
    showCreateHeartbeatModal() {
      this.showModal({
        name: MODALS.createHeartbeat,
        config: {
          action: heartbeat => this.createHeartbeatWithPopup({ data: heartbeat }),
        },
      });
    },

    showDeleteHeartbeatModal(id) {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeHeartbeatWithPopup({ id }),
        },
      });
    },

    showDeleteSelectedHeartbeatsModal(selected) {
      this.showModal({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeSelectedHeartbeatsWithPopup(selected),
        },
      });
    },

    async createHeartbeatWithPopup({ data }) {
      await this.createHeartbeat({ data });
      this.addSuccessPopup({ text: this.$t('modals.createHeartbeat.create.success') });
      this.refreshHeartbeatsList();
    },

    async removeHeartbeatWithPopup({ id }) {
      await this.removeHeartbeat({ id });
      this.addSuccessPopup({ text: this.$t('modals.createHeartbeat.remove.success') });
      this.refreshHeartbeatsList();
    },

    async removeSelectedHeartbeatsWithPopup(selected) {
      await Promise.all(selected.map(({ _id: id }) => this.removeHeartbeat({ id })));
      this.addSuccessPopup({ text: this.$t('modals.createHeartbeat.remove.success') });
      this.refreshWebhooksList();
    },
  },
};
</script>

