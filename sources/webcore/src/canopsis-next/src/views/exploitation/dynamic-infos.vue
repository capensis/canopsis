<template lang="pug">
  div
    dynamic-infos-list(
      :query.sync="query",
      :showEditDynamicInfoModal="showEditDynamicInfoModal",
      :showDeleteDynamicInfoModal="showDeleteDynamicInfoModal",
      :showDeleteSelectedDynamicInfosModal="showDeleteSelectedDynamicInfosModal"
    )
    .fab
      v-layout(column)
        refresh-btn(@click="refreshDynamicInfosList")
        v-tooltip(left)
          v-btn(slot="activator", @click="showCreateDynamicInfoModal", color="primary", dark, fab, icon)
            v-icon add
          span {{ $t('modals.createDynamicInfo.create.title') }}
</template>

<script>
import { isEmpty, isEqual } from 'lodash';
import { MODALS } from '@/constants';
import { PAGINATION_LIMIT } from '@/config';

import entitiesDynamicInfoMixin from '@/mixins/entities/dynamic-info';

import DynamicInfosList from '@/components/other/dynamic-info/exploitation/dynamic-infos-list.vue';
import RefreshBtn from '@/components/other/view/buttons/refresh-btn.vue';

export default {
  components: {
    DynamicInfosList,
    RefreshBtn,
  },
  mixins: [
    entitiesDynamicInfoMixin,
  ],
  data() {
    return {
      query: {
        page: 1,
        limit: PAGINATION_LIMIT,
        search: '',
      },
    };
  },
  watch: {
    query(value, oldValue) {
      if (!isEqual(value, oldValue) && !isEmpty(value)) {
        this.fetchList();
      }
    },
  },
  mounted() {
    this.fetchList();
  },
  methods: {
    showCreateDynamicInfoModal() {
      this.$modals.show({
        name: MODALS.createDynamicInfo,
        config: {
          action: info => this.createDynamicInfoWithPopup({ data: info }),
        },
      });
    },

    showEditDynamicInfoModal(dynamicInfo) {
      this.$modals.show({
        name: MODALS.createDynamicInfo,
        config: {
          dynamicInfo,
          action: data => this.updateDynamicInfoWithPopup({ id: dynamicInfo._id, data }),
        },
      });
    },

    showDeleteDynamicInfoModal(id) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeDynamicInfoWithPopup({ id }),
        },
      });
    },

    showDeleteSelectedDynamicInfosModal(selected) {
      this.$modals.show({
        name: MODALS.confirmation,
        config: {
          action: () => this.removeSelectedDynamicInfosWithPopup(selected),
        },
      });
    },

    async createDynamicInfoWithPopup({ data }) {
      await this.createDynamicInfo({ data });
      this.$popups.success({ text: this.$t('modals.createDynamicInfo.create.success') });
      this.refreshDynamicInfosList();
    },

    async updateDynamicInfoWithPopup({ id, data }) {
      await this.updateDynamicInfo({ id, data });
      this.$popups.success({ text: this.$t('modals.createDynamicInfo.edit.success') });
      this.refreshDynamicInfosList();
    },

    async removeDynamicInfoWithPopup({ id }) {
      await this.removeDynamicInfo({ id });
      this.$popups.success({ text: this.$t('modals.createDynamicInfo.remove.success') });
      this.refreshDynamicInfosList();
    },

    async removeSelectedDynamicInfosWithPopup(selected) {
      await Promise.all(selected.map(({ _id: id }) => this.removeDynamicInfo({ id })));
      this.$popups.success({ text: this.$t('modals.createDynamicInfo.remove.success') });
      this.refreshDynamicInfosList();
    },

    getQuery() {
      const query = {};

      const {
        page,
        limit = PAGINATION_LIMIT,
        search,
      } = this.query;

      query.limit = limit;
      query.skip = ((page - 1) * limit) || 0;

      if (search) {
        query.search = search;
      }

      return query;
    },

    fetchList() {
      const query = this.getQuery();
      this.fetchDynamicInfosList({ params: query });
    },
  },
};
</script>

